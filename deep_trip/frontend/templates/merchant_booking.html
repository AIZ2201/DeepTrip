{% extends "layout.html" %}
{% block title %}商家订单管理 - 旅游小助手{% endblock %}

{% block css %}
<style>
    /* 页面容器 */
    .merchant-orders-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .page-header { margin-bottom: 25px; }
    .page-header h1 { font-size: 26px; color: #333; }
    .page-header p { color: #666; }

    /* 状态统计卡片 */
    .order-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap: 15px; margin-bottom: 25px; }
    .stat-card { background: #fff; border-radius: 8px; padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .stat-value { font-size: 22px; font-weight: bold; margin-bottom: 5px; }
    .stat-label { color: #666; font-size: 14px; }
    .stat-pending .stat-value { color: #FF9800; }
    .stat-confirmed .stat-value { color: #2196F3; }
    .stat-completed .stat-value { color: #4CAF50; }
    .stat-cancelled .stat-value { color: #F44336; }

    /* 表格 */
    .orders-table-container { background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 15px; border-bottom: 1px solid #eee; text-align: center; }
    th { background: #f8f9fa; font-size: 14px; font-weight: 600; }
    tr:hover { background: #fafafa; }

    /* 状态标签 */
    .status-badge { padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 500; }
    .status-pending { background: #FFF3E0; color: #FF9800; }
    .status-confirmed { background: #E3F2FD; color: #2196F3; }
    .status-completed { background: #E8F5E9; color: #4CAF50; }
    .status-cancelled { background: #FFEBEE; color: #F44336; }

    /* 操作按钮 */
    .btn-action { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-size: 12px; margin: 2px; }
    .btn-view { background: #2196F3; color: #fff; }
    .btn-confirm { background: #4CAF50; color: #fff; }
    .btn-cancel { background: #F44336; color: #fff; }
    .btn-complete { background: #9C27B0; color: #fff; }

    /* 分页 */
    .pagination { display: flex; justify-content: center; gap: 5px; margin-top: 15px; }
    .pagination-btn { padding: 6px 10px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    .pagination-btn.active { background: #4CAF50; color: #fff; }
</style>
{% endblock %}

{% block content %}
<div class="merchant-orders-container">
    <!-- 页面头部 -->
    <div class="page-header">
        <h1>订单管理</h1>
        <p>查看并管理用户预订的订单</p>
    </div>

    <!-- 状态统计 -->
    <div class="order-stats">
        <div class="stat-card stat-pending">
            <div class="stat-value">{{ pending_count }}</div>
            <div class="stat-label">待处理</div>
        </div>
        <div class="stat-card stat-confirmed">
            <div class="stat-value">{{ confirmed_count }}</div>
            <div class="stat-label">已确认</div>
        </div>
        <div class="stat-card stat-completed">
            <div class="stat-value">{{ completed_count }}</div>
            <div class="stat-label">已完成</div>
        </div>
        <div class="stat-card stat-cancelled">
            <div class="stat-value">{{ cancelled_count }}</div>
            <div class="stat-label">已取消</div>
        </div>
    </div>

    <!-- 订单表格 -->
    <div class="orders-table-container">
        <table>
            <thead>
                <tr>
                    <th>订单号</th>
                    <th>用户</th>
                    <th>产品</th>
                    <th>金额</th>
                    <th>状态</th>
                    <th>时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr>
                    <td>{{ order.order_id }}</td>
                    <td>{{ order.username }}</td>
                    <td>{{ order.product_name }}</td>
                    <td>¥{{ order.amount }}</td>
                    <td><span class="status-badge status-{{ order.status }}">{{ order.status_text }}</span></td>
                    <td>{{ order.order_time }}</td>
                    <td>
                        {% if order.status == 'pending' %}
                        <button class="btn-action btn-confirm" data-id="{{ order.order_id }}">同意</button>
                        <button class="btn-action btn-cancel" data-id="{{ order.order_id }}">驳回</button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- 分页 -->
        <div class="pagination">
            <button class="pagination-btn" {% if current_page == 1 %}disabled{% endif %}>上一页</button>
            {% for page in page_range %}
            <button class="pagination-btn {% if page == current_page %}active{% endif %}">{{ page }}</button>
            {% endfor %}
            <button class="pagination-btn" {% if current_page == total_pages %}disabled{% endif %}>下一页</button>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // 查看订单按钮
    document.querySelectorAll('.btn-view').forEach(btn => {
        btn.onclick = () => alert("查看订单 " + btn.dataset.id);
    });
    
    // 确认退款按钮 - 当状态为pending时显示（用户申请退款后）
    document.querySelectorAll('.btn-confirm').forEach(btn => {
        btn.onclick = function() {
            const orderId = this.dataset.id;
            if (confirm(`确定要确认订单 ${orderId} 的退款申请吗？确认后订单将被取消。`)) {
                updateOrderStatus(orderId, 'confirm_refund', '确认退款');
            }
        };
    });
    
    // 驳回退款按钮 - 当状态为pending时显示（用户申请退款后）
    document.querySelectorAll('.btn-cancel').forEach(btn => {
        btn.onclick = function() {
            const orderId = this.dataset.id;
            if (confirm(`确定要驳回订单 ${orderId} 的退款申请吗？驳回后订单将恢复为已完成状态。`)) {
                updateOrderStatus(orderId, 'reject_refund', '驳回退款');
            }
        };
    });
    
    // 完成订单按钮
    document.querySelectorAll('.btn-complete').forEach(btn => {
        btn.onclick = () => alert("完成订单 " + btn.dataset.id);
    });
    
    // 发送AJAX请求更新订单状态
    function updateOrderStatus(orderId, action, actionText) {
        fetch('/merchant/orders/update_status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                order_id: orderId,
                action: action
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`订单 ${orderId} ${actionText}成功！`);
                // 刷新页面以显示最新状态
                location.reload();
            } else {
                alert(`操作失败：${data.message}`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('网络错误，请重试');
        });
    }
});
</script>
{% endblock %}