{% extends "layout.html" %}

{% block title %}èµ„æºé¢„å®š - æ—…æ¸¸å°åŠ©æ‰‹{% endblock %}

{% block css %}
<style>
    /* èµ„æºé¢„å®šé¡µé¢æ ·å¼ */
    .booking-container {
        margin-bottom: 40px;
    }
    
    .booking-tabs {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        border-bottom: 2px solid #eee;
    }
    
    .booking-tab {
        padding: 10px 20px;
        cursor: pointer;
        font-size: 18px;
        font-weight: 500;
        color: #7f8c8d;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
    }
    
    .booking-tab.active {
        color: #3498db;
        border-bottom-color: #3498db;
    }
    
    .booking-content {
        display: none;
    }
    
    .booking-content.active {
        display: block;
    }
    
    /* ç­›é€‰å™¨æ ·å¼ */
    .filter-bar {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
        padding: 20px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* èµ„æºåˆ—è¡¨æ ·å¼ */
    .resource-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 30px;
    }
    
    .resource-card {
        background-color: #fff;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .resource-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .resource-image {
        height: 200px;
        overflow: hidden;
    }
    
    .resource-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }
    
    .resource-card:hover .resource-image img {
        transform: scale(1.05);
    }
    
    .resource-content {
        padding: 20px;
    }
    
    .resource-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 10px;
        color: #2c3e50;
    }
    
    .resource-location {
        display: flex;
        align-items: center;
        color: #7f8c8d;
        margin-bottom: 15px;
    }
    
    .resource-location i {
        margin-right: 5px;
    }
    
    .resource-rating {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .star-rating {
        color: #f39c12;
        margin-right: 10px;
    }
    
    .rating-score {
        font-weight: 600;
    }
    
    .resource-price {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }
    
    .price-value {
        font-size: 24px;
        font-weight: 700;
        color: #e74c3c;
    }
    
    .price-unit {
        font-size: 14px;
        color: #7f8c8d;
    }
    
    /* åˆ†é¡µæ ·å¼å¢å¼º */
    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 40px;
    }
    
    /* é¢„å®šæ¨¡æ€æ¡†æ ·å¼ */
    .booking-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1001;
    }
    
    .booking-modal.active {
        display: flex;
    }
    
    .modal-dialog {
        background-color: white;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-title {
        margin: 0;
        font-size: 24px;
    }
    
    .close-modal {
        font-size: 24px;
        cursor: pointer;
        color: #7f8c8d;
    }
    
    .close-modal:hover {
        color: #333;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .modal-footer {
        padding: 20px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    
    /* è®¢å•å†å²æ ·å¼ */
    .order-history {
        margin-top: 40px;
    }
    
    .order-item {
        background-color: #fff;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .order-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .order-id {
        font-weight: 600;
        color: #34495e;
    }
    
    .order-status {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
    }
    
    .status-pending {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .status-confirmed {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-cancelled {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .order-details {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
    }
    
    .detail-item {
        display: flex;
        flex-direction: column;
    }
    
    .detail-label {
        font-size: 14px;
        color: #7f8c8d;
        margin-bottom: 5px;
    }
    
    .detail-value {
        font-weight: 500;
    }
    
    .order-actions {
        margin-top: 20px;
        display: flex;
        gap: 10px;
    }
</style>
{% endblock %}

{% block content %}
<h1>èµ„æºé¢„å®š</h1>
<p>é¢„è®¢æ‚¨çš„å®Œç¾æ—…ç¨‹ï¼ŒåŒ…æ‹¬é…’åº—ã€æ™¯åŒºé—¨ç¥¨å’Œç‰¹è‰²é¤é¥®ã€‚</p>

<!-- é¢„å®šæ ‡ç­¾é¡µ -->
<div class="booking-tabs">
    <div class="booking-tab active" data-tab="hotels">é…’åº—</div>
    <div class="booking-tab" data-tab="attractions">æ™¯åŒº</div>
    <div class="booking-tab" data-tab="restaurants">é¤é¥®</div>
    <div class="booking-tab" data-tab="history">è®¢å•å†å²</div>
</div>

<!-- é…’åº—å†…å®¹ -->
<div class="booking-content active" id="hotels-content">
    <!-- èµ„æºç½‘æ ¼éƒ¨åˆ†ä¿æŒä¸å˜ -->
    <div class="resource-grid">
        <!-- åŠ¨æ€ç”Ÿæˆé…’åº—åˆ—è¡¨ - æŒ‰æœåŠ¡ç±»åˆ«åˆ›å»ºå•ç‹¬å¡ç‰‡ -->
        {% for hotel in hotels %}
            {% if hotel.service_category_ratings and hotel.service_category_ratings|length > 0 %}
                <!-- æœ‰æœåŠ¡ç±»åˆ«è¯„åˆ†æ—¶ï¼Œä¸ºæ¯ä¸ªæœåŠ¡ç±»åˆ«åˆ›å»ºå•ç‹¬å¡ç‰‡ -->
                {% for service_category, rating_info in hotel.service_category_ratings.items() %}
                <div class="resource-card" data-id="{{ hotel.merchant_id }}" data-type="hotel" data-service="{{ service_category }}">
                    <div class="resource-image">
                        {% if hotel.images and hotel.images|length > 0 %}
                        <img src="{{ hotel.images[0] }}" alt="{{ service_category }}">
                        {% else %}
                        <img src="https://picsum.photos/id/1031/800/500" alt="{{ service_category }}">
                        {% endif %}
                    </div>
                    <div class="resource-content">
                        <h3 class="resource-title">{{ service_category }}</h3>
                        <div class="resource-location">
                            <i class="icon-map-marker">ğŸ“</i>
                            <span>{{ hotel.address }}</span>
                        </div>
                        
                        <!-- æœåŠ¡ç±»åˆ«è¯„åˆ† -->
                        <div class="resource-rating">
                            <div class="star-rating">
                                {% for i in range(5) %}
                                    {% if i < rating_info.avg_rating | int %}
                                        <span class="star filled">â˜…</span>
                                    {% else %}
                                        <span class="star">â˜†</span>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <span class="rating-score">{{ "%.1f"|format(rating_info.avg_rating) }}</span>
                            <span class="review-count">({{ rating_info.review_count }}æ¡è¯„ä»·)</span>
                        </div>
                        
                        <p>{{ hotel.description }}</p>
                        <div class="resource-price">
                            <div>
                                <span class="price-value">Â¥{{ hotel.price_range }}</span>
                                <span class="price-unit">/æ™šèµ·</span>
                            </div>
                            <button class="btn btn-primary book-now" data-merchant-id="{{ hotel.merchant_id }}" data-service="{{ service_category }}">ç«‹å³é¢„è®¢</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <!-- æ²¡æœ‰æœåŠ¡ç±»åˆ«è¯„åˆ†æ—¶ï¼Œæ˜¾ç¤ºåŸå§‹é…’åº—å¡ç‰‡ -->
                <div class="resource-card" data-id="{{ hotel.merchant_id }}" data-type="hotel">
                    <div class="resource-image">
                        {% if hotel.images and hotel.images|length > 0 %}
                        <img src="{{ hotel.images[0] }}" alt="{{ hotel.name }}">
                        {% else %}
                        <img src="https://picsum.photos/id/1031/800/500" alt="{{ hotel.name }}">
                        {% endif %}
                    </div>
                    <div class="resource-content">
                        <h3 class="resource-title">{{ hotel.merchant_name }}</h3>
                        <div class="resource-location">
                            <i class="icon-map-marker">ğŸ“</i>
                            <span>{{ hotel.address }}</span>
                        </div>
                        
                        <!-- è¯„åˆ†æ˜¾ç¤º -->
                        <div class="resource-rating">
                            <div class="star-rating">
                                {% for i in range(5) %}
                                    {% if i < hotel.avg_rating | int %}
                                        <span class="star filled">â˜…</span>
                                    {% else %}
                                        <span class="star">â˜†</span>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <span class="rating-score">{{ "%.1f"|format(hotel.avg_rating) }}</span>
                            <span class="review-count">({{ hotel.review_count }}æ¡è¯„ä»·)</span>
                        </div>
                        
                        <p>{{ hotel.description }}</p>
                        <div class="resource-price">
                            <div>
                                <span class="price-value">Â¥{{ hotel.price_range }}</span>
                                <span class="price-unit">/æ™šèµ·</span>
                            </div>
                            <button class="btn btn-primary book-now" data-merchant-id="{{ hotel.merchant_id }}">ç«‹å³é¢„è®¢</button>
                        </div>                    
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>
    
    <div class="pagination">
        <a href="#" class="page-item">ä¸Šä¸€é¡µ</a>
        <a href="#" class="page-item active">1</a>
        <a href="#" class="page-item">2</a>
        <a href="#" class="page-item">3</a>
        <span class="page-item">...</span>
        <a href="#" class="page-item">10</a>
        <a href="#" class="page-item">ä¸‹ä¸€é¡µ</a>
    </div>
</div>

<!-- æ™¯åŒºå†…å®¹ -->
<div class="booking-content" id="attractions-content">
    <div class="resource-grid">
        <!-- åŠ¨æ€ç”Ÿæˆæ™¯åŒºåˆ—è¡¨ - æŒ‰æœåŠ¡ç±»åˆ«åˆ›å»ºå•ç‹¬å¡ç‰‡ -->
        {% for attraction in attractions %}
            {% if attraction.service_category_ratings and attraction.service_category_ratings|length > 0 %}
                <!-- æœ‰æœåŠ¡ç±»åˆ«è¯„åˆ†æ—¶ï¼Œä¸ºæ¯ä¸ªæœåŠ¡ç±»åˆ«åˆ›å»ºå•ç‹¬å¡ç‰‡ -->
                {% for service_category, rating_info in attraction.service_category_ratings.items() %}
                <div class="resource-card" data-id="{{ attraction.merchant_id }}" data-type="attraction" data-service="{{ service_category }}">
                    <div class="resource-image">
                        {% if attraction.images and attraction.images|length > 0 %}
                        <img src="{{ attraction.images[0] }}" alt="{{ attraction.merchant_name }}">
                        {% else %}
                        <img src="https://picsum.photos/id/1036/800/500" alt="{{ attraction.merchant_name }}">
                        {% endif %}
                    </div>
                    <div class="resource-content">
                        <h3 class="resource-title">{{ attraction.merchant_name }}</h3>
                        <div class="resource-subtitle">{{ service_category }}</div>
                        <div class="resource-location">
                            <i class="icon-map-marker">ğŸ“</i>
                            <span>{{ attraction.address }}</span>
                        </div>
                        
                        <!-- æœåŠ¡ç±»åˆ«è¯„åˆ† -->
                        <div class="resource-rating">
                            <div class="star-rating">
                                {% for i in range(5) %}
                                    {% if i < rating_info.avg_rating | int %}
                                        <span class="star filled">â˜…</span>
                                    {% else %}
                                        <span class="star">â˜†</span>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <span class="rating-score">{{ "%.1f"|format(rating_info.avg_rating) }}</span>
                            <span class="review-count">({{ rating_info.review_count }}æ¡è¯„ä»·)</span>
                        </div>
                        
                        <p>{{ attraction.description }}</p>
                        <div class="resource-price">
                            <div>
                                <span class="price-value">Â¥{{ attraction.price_range }}</span>
                                <span class="price-unit">/äººèµ·</span>
                            </div>
                            <button class="btn btn-primary book-now" data-merchant-id="{{ attraction.merchant_id }}" data-service="{{ service_category }}">ç«‹å³é¢„è®¢</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <!-- æ²¡æœ‰æœåŠ¡ç±»åˆ«è¯„åˆ†æ—¶ï¼Œæ˜¾ç¤ºåŸå§‹æ™¯åŒºå¡ç‰‡ -->
                <div class="resource-card" data-id="{{ attraction.merchant_id }}" data-type="attraction">
                    <div class="resource-image">
                        {% if attraction.images and attraction.images|length > 0 %}
                        <img src="{{ attraction.images[0] }}" alt="{{ attraction.merchant_name }}">
                        {% else %}
                        <img src="https://picsum.photos/id/1036/800/500" alt="{{ attraction.merchant_name }}">
                        {% endif %}
                    </div>
                    <div class="resource-content">
                        <h3 class="resource-title">{{ attraction.merchant_name }}</h3>
                        <div class="resource-location">
                            <i class="icon-map-marker">ğŸ“</i>
                            <span>{{ attraction.address }}</span>
                        </div>
                        
                        <!-- æ™¯åŒºè¯„åˆ†æ˜¾ç¤º -->
                        <div class="resource-rating">
                            <div class="star-rating">
                                {% for i in range(5) %}
                                    {% if i < attraction.avg_rating | int %}
                                        <span class="star filled">â˜…</span>
                                    {% else %}
                                        <span class="star">â˜†</span>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <span class="rating-score">{{ "%.1f"|format(attraction.avg_rating) }}</span>
                            <span class="review-count">({{ attraction.review_count }}æ¡è¯„ä»·)</span>
                        </div>
                        
                        <p>{{ attraction.description }}</p>
                        <div class="resource-price">
                            <div>
                                <span class="price-value">Â¥{{ attraction.price_range }}</span>
                                <span class="price-unit">/äººèµ·</span>
                            </div>
                            <button class="btn btn-primary book-now" data-merchant-id="{{ attraction.merchant_id }}">ç«‹å³é¢„è®¢</button>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>
</div>

<!-- é¤å…å†…å®¹ -->
<div class="booking-content" id="restaurants-content">
    <div class="resource-grid">
        <!-- åŠ¨æ€ç”Ÿæˆé¤å…åˆ—è¡¨ - æŒ‰æœåŠ¡ç±»åˆ«åˆ›å»ºå•ç‹¬å¡ç‰‡ -->
        {% for restaurant in restaurants %}
        <div class="resource-card" data-id="{{ restaurant.merchant_id }}" data-type="restaurant">
            <div class="resource-image">
                {% if restaurant.images and restaurant.images|length > 0 %}
                <img src="{{ restaurant.images[0] }}" alt="{{ restaurant.merchant_name }}">
                {% else %}
                <img src="https://picsum.photos/id/292/800/500" alt="{{ restaurant.merchant_name }}">
                {% endif %}
            </div>
            <div class="resource-content">
                <h3 class="resource-title">{{ restaurant.merchant_name }}</h3>
                <div class="resource-location">
                    <i class="icon-map-marker">ğŸ“</i>
                    <span>{{ restaurant.address }}</span>
                </div>
                
                <!-- é¤å…è¯„åˆ†æ˜¾ç¤º -->
                {% if restaurant.shop_info and restaurant.feedback_info %}
                <div class="resource-rating">
                    <div class="star-rating">
                        {% for i in range(5) %}
                            {% if i < restaurant.feedback_info.avg_rating | int %}
                                <span class="star filled">â˜…</span>
                            {% else %}
                                <span class="star">â˜†</span>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <span class="rating-score">{{ "%.1f"|format(restaurant.feedback_info.avg_rating) }}</span>
                    <span class="review-count">({{ restaurant.feedback_info.review_count }}æ¡è¯„ä»·)</span>
                </div>
                {% else %}
                <div class="resource-rating">
                    <div class="star-rating">
                        {% for i in range(5) %}
                            {% if i < restaurant.avg_rating | int %}
                                <span class="star filled">â˜…</span>
                            {% else %}
                                <span class="star">â˜†</span>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <span class="rating-score">{{ "%.1f"|format(restaurant.avg_rating) }}</span>
                    <span class="review-count">({{ restaurant.review_count }}æ¡è¯„ä»·)</span>
                </div>
                {% endif %}
                
                <p>{{ restaurant.description }}</p>
                <div class="resource-price">
                    <div>
                        <span class="price-value">Â¥{{ restaurant.price_range }}</span>
                        <span class="price-unit">/äººèµ·</span>
                    </div>
                    <button class="btn btn-primary book-now">ç«‹å³é¢„è®¢</button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- è®¢å•å†å²å†…å®¹ -->
<div class="booking-content" id="history-content">
    <div class="order-history">
        <h3>æˆ‘çš„è®¢å•</h3>
        <div style="text-align: center; padding: 40px; color: #666;">
            <p>ç‚¹å‡»ä¸Šæ–¹"è®¢å•å†å²"æ ‡ç­¾åŠ è½½æ‚¨çš„è®¢å•</p>
        </div>
    </div>
</div>

<!-- é¢„è®¢æ¨¡æ€æ¡† -->
<div class="booking-modal" id="booking-modal">
    <div class="modal-dialog">
        <div class="modal-header">
            <h2 class="modal-title" id="modal-resource-title">é¢„è®¢ç¡®è®¤</h2>
            <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
            <form id="booking-form">
                <input type="hidden" id="resource-id" name="resource_id">
                <input type="hidden" id="resource-type" name="resource_type">
                
                <div id="booking-fields">
                    <!-- é¢„è®¢å­—æ®µå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div class="form-group">
                    <label for="contact-name">è”ç³»äººå§“å</label>
                    <input type="text" id="contact-name" name="contact_name" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="contact-phone">è”ç³»ç”µè¯</label>
                    <input type="tel" id="contact-phone" name="contact_phone" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label class="form-check-label">
                        <input type="checkbox" name="agree_terms" class="form-check-input" required>
                        æˆ‘å·²é˜…è¯»å¹¶åŒæ„<a href="#" target="_blank">é¢„è®¢æ¡æ¬¾</a>å’Œ<a href="#" target="_blank">é€€æ¬¾æ”¿ç­–</a>
                    </label>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary close-modal">å–æ¶ˆ</button>
            <button type="submit" form="booking-form" class="btn btn-primary">æäº¤é¢„è®¢</button>
        </div>
    </div>
</div>

{% endblock %}
{% block js %}
<script>
// åŠ è½½ç”¨æˆ·è®¢å•
function loadUserOrders() {
    showLoading();
    
    fetch('/user_orders', {
        method: 'GET',
        credentials: 'same-origin'
    })
    .then(response => {
        if (response.status === 401) {
            hideLoading();
            showAlert('è¯·å…ˆç™»å½•ä»¥æŸ¥çœ‹è®¢å•å†å²', 'info');
            return null;
        }
        return response.json();
    })
    .then(data => {
        hideLoading();
        if (data && data.success) {
            renderOrders(data.orders);
        } else if (data) {
            showAlert(data.message || 'è·å–è®¢å•å¤±è´¥', 'error');
        }
    })
    .catch(error => {
        hideLoading();
        showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
    });
}

// æ¸²æŸ“è®¢å•åˆ—è¡¨ - ä¼˜åŒ–ç‰ˆï¼ˆé˜²æ­¢é‡å¤è®¢å•ï¼‰
function renderOrders(orders) {
    const orderHistoryContainer = document.querySelector('#history-content .order-history');
    
    // éªŒè¯å®¹å™¨æ˜¯å¦å­˜åœ¨
    if (!orderHistoryContainer) {
        console.error('è®¢å•å®¹å™¨å…ƒç´ ä¸å­˜åœ¨');
        return;
    }
    
    // æ¸…ç©ºå®¹å™¨ï¼ˆå…³é”®ï¼šé˜²æ­¢é‡å¤è¿½åŠ ï¼‰
    orderHistoryContainer.innerHTML = '';
    
    if (orders.length === 0) {
        orderHistoryContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
                <h4>æš‚æ— è®¢å•</h4>
                <p>æ‚¨è¿˜æ²¡æœ‰ä»»ä½•é¢„è®¢è®°å½•</p>
            </div>
        `;
        return;
    }
    
    // å»é‡å¤„ç†ï¼šé€šè¿‡è®¢å•IDç¡®ä¿å”¯ä¸€æ€§
    const uniqueOrders = Array.from(
        new Map(orders.map(order => [order.id, order])).values()
    );
    
    let ordersHtml = '<h3>æˆ‘çš„è®¢å•</h3>';
    
    uniqueOrders.forEach(order => {
        // æ ¼å¼åŒ–çŠ¶æ€æ˜¾ç¤º
        let statusClass = 'status-pending';
        let statusText = 'å¤„ç†ä¸­';
        if (order.status === 'confirmed') {
            statusClass = 'status-confirmed';
            statusText = 'å·²ç¡®è®¤';
        } else if (order.status === 'cancelled') {
            statusClass = 'status-cancelled';
            statusText = 'å·²å–æ¶ˆ';
        }
        
        // ç¡®å®šæ—¥æœŸæ ‡ç­¾æ–‡æœ¬
        const dateLabel = order.category === 'hotel' ? 'å…¥ä½' : 
                          order.category === 'restaurant' ? 'ç”¨é¤' : 'å‚è§‚';
        
        ordersHtml += `
            <div class="order-item" data-order-id="${order.id}">
                <div class="order-header">
                    <div class="order-id">è®¢å•ç¼–å·ï¼šORD-${order.id}</div>
                    <div class="order-status ${statusClass}">${statusText}</div>
                </div>
                <div class="order-details">
                    <div class="detail-item">
                        <div class="detail-label">é¢„è®¢é¡¹ç›®</div>
                        <div class="detail-value">${order.service_name}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${dateLabel}æ—¥æœŸ</div>
                        <div class="detail-value">${order.service_start_time ? order.service_start_time.split(' ')[0] : 'æœªè®¾ç½®'}</div>
                    </div>
                    ${order.category === 'hotel' && order.service_end_time ? `
                    <div class="detail-item">
                        <div class="detail-label">ç¦»åº—æ—¥æœŸ</div>
                        <div class="detail-value">${order.service_end_time.split(' ')[0]}</div>
                    </div>
                    ` : ''}
                    <div class="detail-item">
                        <div class="detail-label">æ€»é‡‘é¢</div>
                        <div class="detail-value">Â¥${order.price || 0}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">é¢„è®¢æ—¶é—´</div>
                        <div class="detail-value">${order.book_time || 'æœªçŸ¥æ—¶é—´'}</div>
                    </div>
                </div>
                <div class="order-actions">
                    ${order.status === 'confirmed' ? '<button class="btn btn-secondary cancel-order" data-id="' + order.id + '">ç”³è¯·é€€è®¢</button>' : ''}
                </div>
            </div>
        `;
    });
    
    orderHistoryContainer.innerHTML = ordersHtml;
    // åœ¨è®¢å•æ¸²æŸ“å®Œæˆåç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    bindOrderActionEvents();
}

// ç»‘å®šè®¢å•æ“ä½œæŒ‰é’®äº‹ä»¶
function bindOrderActionEvents() {
    const cancelButtons = document.querySelectorAll('.cancel-order');
    cancelButtons.forEach(button => {
        button.addEventListener('click', function() {
            const orderId = this.getAttribute('data-id');
            
            if (confirm('ç¡®å®šè¦ç”³è¯·é€€è®¢æ­¤è®¢å•å—ï¼Ÿ')) {
                showLoading();
                
                // å‘é€é€€è®¢è¯·æ±‚åˆ°åç«¯
                fetch('/cancel_order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ order_id: orderId })
                })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showAlert(data.message, 'success');
                        // é‡æ–°åŠ è½½è®¢å•åˆ—è¡¨
                        loadUserOrders();
                    } else {
                        showAlert(data.message, 'error');
                    }
                })
                .catch(error => {
                    hideLoading();
                    showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
                });
            }
        });
    });
}

// åœ¨é¡µé¢åŠ è½½æ—¶ç›‘å¬è®¢å•å†å²æ ‡ç­¾ç‚¹å‡»äº‹ä»¶
document.addEventListener('DOMContentLoaded', function() {
    // ç›‘å¬è®¢å•å†å²æ ‡ç­¾ç‚¹å‡»
    const historyTab = document.querySelector('.booking-tab[data-tab="history"]');
    if (historyTab) {
        historyTab.addEventListener('click', function() {
            loadUserOrders();
        });
    }
});
    // åœ¨<script>æ ‡ç­¾å¼€å§‹å¤„æ·»åŠ ä»¥ä¸‹å‡½æ•°å®šä¹‰
    function showLoading() {
        // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰åŠ è½½å…ƒç´ ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»º
        let loadingElement = document.getElementById('loading-overlay');
        if (!loadingElement) {
            loadingElement = document.createElement('div');
            loadingElement.id = 'loading-overlay';
            loadingElement.style.position = 'fixed';
            loadingElement.style.top = '0';
            loadingElement.style.left = '0';
            loadingElement.style.width = '100%';
            loadingElement.style.height = '100%';
            loadingElement.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            loadingElement.style.display = 'flex';
            loadingElement.style.justifyContent = 'center';
            loadingElement.style.alignItems = 'center';
            loadingElement.style.zIndex = '1000';
            loadingElement.innerHTML = '<div style="background-color: white; padding: 20px; border-radius: 8px;">å¤„ç†ä¸­...</div>';
            document.body.appendChild(loadingElement);
        }
        loadingElement.style.display = 'flex';
    }
    
    function hideLoading() {
        const loadingElement = document.getElementById('loading-overlay');
        if (loadingElement) {
            loadingElement.style.display = 'none';
        }
    }
    
    function showAlert(message, type = 'info') {
        // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æç¤ºå…ƒç´ ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»º
        let alertElement = document.getElementById('custom-alert');
        if (!alertElement) {
            alertElement = document.createElement('div');
            alertElement.id = 'custom-alert';
            alertElement.style.position = 'fixed';
            alertElement.style.top = '20px';
            alertElement.style.left = '50%';
            alertElement.style.transform = 'translateX(-50%)';
            alertElement.style.padding = '15px 20px';
            alertElement.style.borderRadius = '8px';
            alertElement.style.color = 'white';
            alertElement.style.fontWeight = '500';
            alertElement.style.zIndex = '1001';
            alertElement.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
            alertElement.style.transition = 'opacity 0.3s ease';
            document.body.appendChild(alertElement);
        }
        
        // è®¾ç½®æç¤ºç±»å‹å¯¹åº”çš„èƒŒæ™¯é¢œè‰²
        if (type === 'success') {
            alertElement.style.backgroundColor = '#28a745'; // ç»¿è‰²
        } else if (type === 'error') {
            alertElement.style.backgroundColor = '#dc3545'; // çº¢è‰²
        } else if (type === 'info') {
            alertElement.style.backgroundColor = '#17a2b8'; // è“è‰²
        } else {
            alertElement.style.backgroundColor = '#6c757d'; // ç°è‰²
        }
        
        // è®¾ç½®æç¤ºä¿¡æ¯å¹¶æ˜¾ç¤º
        alertElement.textContent = message;
        alertElement.style.opacity = '1';
        
        // 3ç§’åè‡ªåŠ¨éšè—
        setTimeout(() => {
            alertElement.style.opacity = '0';
            setTimeout(() => {
                alertElement.style.display = 'none';
            }, 300);
        }, 3000);
    }
    
    // å…¨å±€å•†å®¶æœåŠ¡æ•°æ®
    window.merchantServices = {{ merchant_services | tojson | safe }} || {};
    
    document.addEventListener('DOMContentLoaded', function() {
        // æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
        const bookingTabs = document.querySelectorAll('.booking-tab');
        const bookingContents = document.querySelectorAll('.booking-content');
        
        bookingTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
                bookingTabs.forEach(t => t.classList.remove('active'));
                bookingContents.forEach(c => c.classList.remove('active'));
                
                // æ·»åŠ å½“å‰æ¿€æ´»çŠ¶æ€
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(`${tabId}-content`).classList.add('active');
            });
        });
        
        // é¢„è®¢æ¨¡æ€æ¡†ç›¸å…³
        const bookingModal = document.getElementById('booking-modal');
        const closeModalButtons = document.querySelectorAll('.close-modal');
        const bookNowButtons = document.querySelectorAll('.book-now');
        const bookingForm = document.getElementById('booking-form');
        const modalResourceTitle = document.getElementById('modal-resource-title');
        const bookingFields = document.getElementById('booking-fields');
        
        // æ‰“å¼€é¢„è®¢æ¨¡æ€æ¡†
        bookNowButtons.forEach(button => {
            button.addEventListener('click', function() {
                const resourceCard = this.closest('.resource-card');
                const resourceId = resourceCard.getAttribute('data-id');
                const resourceType = resourceCard.getAttribute('data-type');
                const resourceTitle = resourceCard.querySelector('.resource-title').textContent;
                
                // è®¾ç½®æ¨¡æ€æ¡†æ ‡é¢˜
                modalResourceTitle.textContent = `é¢„è®¢ï¼š${resourceTitle}`;
                
                // è®¾ç½®éšè—å­—æ®µ
                document.getElementById('resource-id').value = resourceId;
                document.getElementById('resource-type').value = resourceType;
                
                // æ ¹æ®èµ„æºç±»å‹ç”Ÿæˆä¸åŒçš„é¢„è®¢å­—æ®µ
                generateBookingFields(resourceType);
                
                // ä¿®å¤ï¼šåŒæ­¥ç­›é€‰æ ä¸­çš„æ—¥æœŸåˆ°é¢„è®¢æ¨¡æ€æ¡†
                if (resourceType === 'hotel') {
                    const filterCheckin = document.getElementById('hotel-checkin');
                    const modalCheckin = document.getElementById('modal-hotel-checkin');
                    if (filterCheckin && filterCheckin.value && modalCheckin) {
                        modalCheckin.value = filterCheckin.value;
                    }
                    const filterCheckout = document.getElementById('hotel-checkout');
                    const modalCheckout = document.getElementById('modal-hotel-checkout');
                    if (filterCheckout && filterCheckout.value && modalCheckout) {
                        modalCheckout.value = filterCheckout.value;
                    }
                } else if (resourceType === 'restaurant') {
                    const filterDate = document.getElementById('restaurant-date');
                    const modalDate = document.getElementById('modal-restaurant-date');
                    if (filterDate && filterDate.value && modalDate) {
                        modalDate.value = filterDate.value;
                    }
                    const filterTime = document.getElementById('restaurant-time');
                    const modalTime = document.getElementById('modal-restaurant-time');
                    if (filterTime && filterTime.value && modalTime) {
                        modalTime.value = filterTime.value;
                    }
                }
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                bookingModal.classList.add('active');
            });
        });
        
        // å…³é—­é¢„è®¢æ¨¡æ€æ¡†
        closeModalButtons.forEach(button => {
            button.addEventListener('click', function() {
                bookingModal.classList.remove('active');
            });
        });
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        bookingModal.addEventListener('click', function(e) {
            if (e.target === bookingModal) {
                bookingModal.classList.remove('active');
            }
        });
        
        // æ ¹æ®èµ„æºç±»å‹ç”Ÿæˆé¢„è®¢å­—æ®µ
        function generateBookingFields(resourceType) {
            let fieldsHtml = '';
            const resourceTitle = document.getElementById('modal-resource-title').textContent.replace('é¢„è®¢ï¼š', '');
            
            if (resourceType === 'hotel') {
                // è·å–å½“å‰é…’åº—çš„æœåŠ¡é¡¹ç›®
                const hotelServices = window.merchantServices[resourceTitle] || [];
                
                let roomOptions = '<option value="">è¯·é€‰æ‹©æˆ¿å‹</option>';
                hotelServices.forEach(service => {
                    roomOptions += `<option value="${service.name}">${service.name}  Â¥${service.price}</option>`;
                });
                
                // å¦‚æœæ²¡æœ‰æœåŠ¡é¡¹ç›®ï¼Œä½¿ç”¨é»˜è®¤é€‰é¡¹
                if (hotelServices.length === 0) {
                    roomOptions = `
                        <option value="standard">æ ‡å‡†é—´</option>
                        <option value="deluxe">è±ªåé—´</option>
                        <option value="suite">å¥—æˆ¿</option>
                    `;
                }
                
                fieldsHtml = `
                    <div class="form-group">
                        <label for="hotel-checkin">å…¥ä½æ—¥æœŸ</label>
                        <input type="date" id="modal-hotel-checkin" name="checkin_date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="hotel-checkout">ç¦»åº—æ—¥æœŸ</label>
                        <input type="date" id="modal-hotel-checkout" name="checkout_date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="hotel-room-type">æˆ¿å‹</label>
                        <select id="hotel-room-type" name="room_type" class="form-control" required>
                            ${roomOptions}
                        </select>
                    </div>
                `;
            } else if (resourceType === 'restaurant') {
                // è·å–å½“å‰é¤å…çš„æœåŠ¡é¡¹ç›®
                const restaurantServices = window.merchantServices[resourceTitle] || [];
                
                let menuOptions = '<option value="">ä¸é€‰æ‹©å¥—é¤</option>';
                restaurantServices.forEach(service => {
                    menuOptions += `<option value="${service.name}">${service.name}  Â¥${service.price}</option>`;
                });
                
                fieldsHtml = `
                    <div class="form-group">
                        <label for="restaurant-date">ç”¨é¤æ—¥æœŸ</label>
                        <input type="date" id="modal-restaurant-date" name="dining_date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="restaurant-time">ç”¨é¤æ—¶é—´</label>
                        <input type="time" id="modal-restaurant-time" name="dining_time" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-restaurant-menu">å¥—é¤é€‰æ‹©ï¼ˆå¯é€‰ï¼‰</label>
                        <select id="modal-restaurant-menu" name="menu" class="form-control">
                            ${menuOptions}
                        </select>
                    </div>
                `;
            } else if (resourceType === 'attraction') {
                fieldsHtml = `
                    <div class="form-group">
                        <label for="attraction-date">å‚è§‚æ—¥æœŸ</label>
                        <input type="date" id="modal-attraction-date" name="visit_date" class="form-control" required>
                    </div>
                `;
            }
            bookingFields.innerHTML = fieldsHtml;
        }
        
// æäº¤é¢„è®¢è¡¨å•
bookingForm.addEventListener('submit', function(e) {
    e.preventDefault();
    showLoading();
    
    // æ”¶é›†è¡¨å•æ•°æ®
    const formData = {
        merchant_id: document.getElementById('resource-id').value,
        category: document.getElementById('resource-type').value,
        service_name: document.getElementById('modal-resource-title').textContent.replace('é¢„è®¢ï¼š', ''),
        customer_name: document.getElementById('contact-name').value,
        phonenumber: document.getElementById('contact-phone').value,
        price: 0 // éœ€è¦æ ¹æ®é€‰æ‹©çš„æˆ¿å‹/å¥—é¤è·å–ä»·æ ¼
    };
    
    // æ ¹æ®èµ„æºç±»å‹æ·»åŠ ç‰¹å®šå­—æ®µ
    const resourceType = formData.category;
    if (resourceType === 'hotel') {
        // è·å–é…’åº—æ—¥æœŸå¹¶éªŒè¯
        const checkinDate = document.getElementById('modal-hotel-checkin').value;
        const checkoutDate = document.getElementById('modal-hotel-checkout').value;
        
        // éªŒè¯æ—¥æœŸé¡ºåº
        if (checkinDate > checkoutDate) {
            showAlert('å…¥ä½æ—¥æœŸä¸èƒ½æ™šäºç¦»åº—æ—¥æœŸ', 'error');
            hideLoading();
            return;
        }
        
        if (!checkinDate || !checkoutDate) {
        showAlert('è¯·é€‰æ‹©å…¥ä½å’Œç¦»åº—æ—¥æœŸ', 'error');
        hideLoading();
        return;
        }
        
        formData.service_start_time = checkinDate + ' 14:00:00';
        formData.service_end_time = checkoutDate + ' 12:00:00';
        
        // è·å–æˆ¿å‹ä»·æ ¼
        const roomSelect = document.getElementById('hotel-room-type');
        const selectedOption = roomSelect.options[roomSelect.selectedIndex];
        if (selectedOption.value) {
            const priceMatch = selectedOption.text.match(/Â¥(\d+)/);
            if (priceMatch) {
                formData.price = priceMatch[1];
            }
        }
    } else if (resourceType === 'restaurant') {
        const diningDate = document.getElementById('modal-restaurant-date').value;
        const diningTime = document.getElementById('modal-restaurant-time').value;
        
        // æ·»åŠ æ—¥æœŸéªŒè¯
        if (!diningDate) {
            showAlert('è¯·é€‰æ‹©ç”¨é¤æ—¥æœŸ', 'error');
            hideLoading();
            return;
        }
        
        // ç¡®ä¿æ—¶é—´æ ¼å¼æ­£ç¡®
        if (diningTime && diningTime.includes(':')) {
            const [hours, minutes] = diningTime.split(':');
            formData.service_start_time = `${diningDate} ${hours}:${minutes}:00`;
            
            // è®¡ç®—ç»“æŸæ—¶é—´ï¼ˆç”¨é¤æ—¶é—´+2å°æ—¶ï¼‰
            const endHours = (parseInt(hours) + 2) % 24;
            const formattedEndHours = endHours.toString().padStart(2, '0');
            formData.service_end_time = `${diningDate} ${formattedEndHours}:${minutes}:00`;
        } else {
            // å¦‚æœæ—¶é—´æ ¼å¼æ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤å€¼
            formData.service_start_time = `${diningDate} 12:00:00`;
            formData.service_end_time = `${diningDate} 14:00:00`;
        }
        
        // è·å–å¥—é¤ä»·æ ¼ - ä¿®æ”¹IDä¸ºæ­£ç¡®çš„modal-restaurant-menu
        const menuSelect = document.getElementById('modal-restaurant-menu');
        if (menuSelect && menuSelect.selectedIndex >= 0) {
            const selectedOption = menuSelect.options[menuSelect.selectedIndex];
            if (selectedOption.value) {
                const priceMatch = selectedOption.text.match(/Â¥(\d+)/);
                if (priceMatch) {
                    formData.price = priceMatch[1];
                }
            }
        }
    } else if (resourceType === 'attraction') {        
        const visitDate = document.getElementById('modal-attraction-date').value;
        
        // æ·»åŠ æ—¥æœŸéªŒè¯
        if (!visitDate) {
            showAlert('è¯·é€‰æ‹©å‚è§‚æ—¥æœŸ', 'error');
            hideLoading();
            return;
        }
        
        formData.service_start_time = `${visitDate} 09:00:00`;
        formData.service_end_time = `${visitDate} 17:00:00`;
        // ä¿®å¤ï¼šä»merchant_servicesä¸­æå–æ™¯åŒºæœåŠ¡ä»·æ ¼
        const resourceTitle = document.getElementById('modal-resource-title').textContent.replace('é¢„è®¢ï¼š', '');
        const attractionServices = window.merchantServices[resourceTitle] || [];
    
        if (attractionServices.length > 0) {
            // ä½¿ç”¨ç¬¬ä¸€ä¸ªæœåŠ¡é¡¹ç›®çš„ä»·æ ¼
            formData.price = attractionServices[0].price || 0;
        } else {
        // å¦‚æœæ²¡æœ‰æœåŠ¡é¡¹ç›®ï¼Œä½¿ç”¨é»˜è®¤ä»·æ ¼50å…ƒ
            formData.price = 50;
        }
    }
    
    // å‘é€AJAXè¯·æ±‚åˆ°åç«¯
    fetch('/submit_booking', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        bookingModal.classList.remove('active');
        
        if (data.success) {
            showAlert(data.message, 'success');
            bookingForm.reset();
        } else {
            showAlert(data.message, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
    });
});

        // æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('hotel-search').addEventListener('click', function() {
            performSearch('hotel');
        });
        
        document.getElementById('attraction-search').addEventListener('click', function() {
            performSearch('attraction');
        });
        
        document.getElementById('restaurant-search').addEventListener('click', function() {
            performSearch('restaurant');
        });
        
        // æ‰§è¡Œæœç´¢
        function performSearch(type) {
            showLoading();
            
            // æ¨¡æ‹Ÿæœç´¢è¯·æ±‚
            setTimeout(() => {
                hideLoading();
                showAlert(`å·²ä¸ºæ‚¨æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„${type === 'hotel' ? 'é…’åº—' : type === 'attraction' ? 'æ™¯åŒº' : 'é¤å…'}ï¼Œè¯·æŸ¥çœ‹ä¸‹æ–¹ç»“æœã€‚`, 'success');
            }, 1500);
        }
        
        // è®¢å•æ“ä½œæŒ‰é’®äº‹ä»¶ï¼ˆçº¦1163-1185è¡Œï¼‰
        const orderButtons = document.querySelectorAll('.order-actions button');
        orderButtons.forEach(button => {
            button.addEventListener('click', function() {
                const action = this.textContent.trim();
                const orderIdElement = this.closest('.order-item').querySelector('.order-id');
                const orderIdText = orderIdElement.textContent;
                
                if (action === 'å–æ¶ˆé¢„è®¢' || action === 'ç”³è¯·é€€è®¢') {
                    if (confirm(`ç¡®å®šè¦${action}æ­¤è®¢å•å—ï¼Ÿ`)) {
                        showLoading();
                        
                        // æå–è®¢å•IDï¼ˆä»è®¢å•ç¼–å·ä¸­æå–ï¼‰
                        const orderId = orderIdText.replace('è®¢å•ç¼–å·ï¼šORD-', '');
                        
                        // å‘é€é€€è®¢è¯·æ±‚åˆ°åç«¯
                        fetch('/cancel_order', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ order_id: orderId })
                        })
                        .then(response => response.json())
                        .then(data => {
                            hideLoading();
                            if (data.success) {
                                showAlert(data.message, 'success');
                                // é‡æ–°åŠ è½½è®¢å•åˆ—è¡¨
                                loadUserOrders();
                            } else {
                                showAlert(data.message, 'error');
                            }
                        })
                        .catch(error => {
                            hideLoading();
                            showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
                        });
                    }
                }
            });
        });
        
        // è®¾ç½®æ—¥æœŸé€‰æ‹©å™¨çš„æœ€å°æ—¥æœŸä¸ºä»Šå¤©
        const dateInputs = document.querySelectorAll('input[type="date"]');
        const today = new Date().toISOString().split('T')[0];
        dateInputs.forEach(input => {
            input.min = today;
        });
        
        // ä¸ºé…’åº—æœç´¢çš„ç¦»åº—æ—¥æœŸè®¾ç½®æœ€å°å€¼ä¸ºå…¥ä½æ—¥æœŸ
        const hotelCheckin = document.getElementById('hotel-checkin');
        const hotelCheckout = document.getElementById('hotel-checkout');
        
        if (hotelCheckin && hotelCheckout) {
            hotelCheckin.addEventListener('change', function() {
                hotelCheckout.min = this.value;
                if (hotelCheckout.value < this.value) {
                    hotelCheckout.value = this.value;
                }
            });
        }
    });
</script>
{% endblock %}