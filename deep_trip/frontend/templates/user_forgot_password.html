{% extends "layout.html" %}

{% block title %}忘记密码 - 旅游小助手{% endblock %}

{% block css %}
<style>
  .fp-container{
    max-width: 480px;margin:40px auto;background:#fff;border-radius:8px;
    box-shadow:0 2px 8px rgba(0,0,0,.08);padding:32px;
  }
  .fp-title{font-size:26px;font-weight:600;color:#2c3e50;text-align:center;margin-bottom:8px}
  .fp-sub{color:#7f8c8d;text-align:center;margin-bottom:24px}
  .form-group{margin-bottom:18px}
  .form-group label{display:block;margin-bottom:6px;color:#34495e;font-weight:500}
  .form-control{width:100%;padding:12px 14px;border:2px solid #e0e0e0;border-radius:4px;font-size:16px;transition:border-color .2s}
  .form-control:focus{outline:none;border-color:#3498db}
  .form-control.error{border-color:#e74c3c}
  .code-row{display:flex;gap:10px}
  .btn, .btn-outline{
    display:inline-block;border:none;border-radius:4px;padding:11px 14px;font-weight:600;cursor:pointer;transition:all .2s;
  }
  .btn{background:#3498db;color:#fff;width:100%}
  .btn:hover{background:#2980b9}
  .btn:disabled{background:#bdc3c7;cursor:not-allowed}
  .btn-outline{border:1px solid #3498db;color:#3498db;background:#fff;white-space:nowrap}
  .btn-outline:disabled{border-color:#ccc;color:#ccc;cursor:not-allowed}
  .alert{padding:12px 14px;border-radius:4px;color:#fff;font-weight:500;margin-bottom:16px}
  .alert-success{background:#27ae60}
  .alert-error{background:#e74c3c}
  .fade-out{opacity:0;transition:opacity .3s}
  .loading-overlay{
    position:fixed;inset:0;background:rgba(255,255,255,.8);display:flex;align-items:center;justify-content:center;z-index:1000
  }
  .spinner{width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .links{text-align:center;margin-top:14px}
  .links a{color:#3498db;text-decoration:none}
  .links a:hover{text-decoration:underline}
  .hint{font-size:12px;color:#7f8c8d;margin-top:4px}
</style>
{% endblock %}

{% block content %}
<div class="fp-container">
  <h1 class="fp-title">忘记密码</h1>
  <p class="fp-sub">输入注册邮箱获取验证码，验证后即可重置密码</p>

  <form id="fp-form">
    <div class="form-group">
      <label for="email">邮箱</label>
      <input id="email" name="email" type="email" class="form-control" placeholder="请输入注册邮箱" required>
      <div class="hint">我们会向该邮箱发送 6 位验证码（10 分钟内有效）</div>
    </div>

    <div class="form-group">
      <label for="code">验证码</label>
      <div class="code-row">
        <input id="code" name="code" type="text" class="form-control" placeholder="请输入 6 位验证码" maxlength="6" required>
        <button type="button" id="send-code" class="btn-outline">获取验证码</button>
      </div>
    </div>

    <div class="form-group">
      <label for="password">新密码</label>
      <input id="password" name="password" type="password" class="form-control" placeholder="设置 8-20 位新密码" required>
    </div>

    <div class="form-group">
      <label for="password2">确认新密码</label>
      <input id="password2" name="password2" type="password" class="form-control" placeholder="再次输入新密码" required>
    </div>

    <button type="submit" id="submit" class="btn">重置密码</button>

    <div class="links">
      <a href="/user/login">返回登录</a>
    </div>
  </form>
</div>
{% endblock %}

{% block js %}
<script>
(function(){
  const form = document.getElementById('fp-form');
  const email = document.getElementById('email');
  const code = document.getElementById('code');
  const pass = document.getElementById('password');
  const pass2 = document.getElementById('password2');
  const btnSend = document.getElementById('send-code');
  const btnSubmit = document.getElementById('submit');
  let timer = null, remain = 0;

  function showAlert(msg, type){
    document.querySelectorAll('.alert').forEach(n=>n.remove());
    const div = document.createElement('div');
    div.className = `alert alert-${type}`;
    div.textContent = msg;
    const box = document.querySelector('.fp-container');
    box.insertBefore(div, box.firstChild);
    setTimeout(()=>{div.classList.add('fade-out'); setTimeout(()=>div.remove(),300)}, 2500);
  }
  function showLoading(){
    hideLoading();
    const d = document.createElement('div');
    d.className = 'loading-overlay';
    d.innerHTML = '<div class="spinner"></div>';
    document.body.appendChild(d);
  }
  function hideLoading(){
    const d = document.querySelector('.loading-overlay'); if(d) d.remove();
  }
  function validateEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }
  function startCountdown(sec){
    remain = sec;
    btnSend.disabled = true;
    btnSend.textContent = `${remain}s 后重试`;
    timer = setInterval(()=>{
      remain--;
      if(remain<=0){
        clearInterval(timer); timer=null;
        btnSend.disabled = false; btnSend.textContent = '获取验证码';
      }else{
        btnSend.textContent = `${remain}s 后重试`;
      }
    }, 1000);
  }

  btnSend.addEventListener('click', function(){
    const v = email.value.trim();
    if(!validateEmail(v)){ email.classList.add('error'); showAlert('请输入有效的邮箱地址', 'error'); return; }
    email.classList.remove('error');

    showLoading();
    const fd = new FormData(); fd.append('email', v);
    fetch('/user/forgot-password/send-code', { method:'POST', body: fd })
      .then(r => { if(!r.ok) throw new Error('网络错误'); return r.json(); })
      .then(d => {
        hideLoading();
        if(d.success){
          showAlert('验证码已发送，请查收邮箱', 'success');
          // 开发期：若后端返回 dev_code，直接填入输入框，方便自测
          if(d.dev_code){ code.value = d.dev_code; }
          startCountdown(60);
        }else{
          showAlert(d.message || '发送失败', 'error');
        }
      })
      .catch(e => { hideLoading(); showAlert('发送失败，请稍后重试', 'error'); console.error(e); });
  });

  form.addEventListener('submit', function(e){
    e.preventDefault();
    const vEmail = email.value.trim();
    const vCode  = code.value.trim();
    const vPass  = pass.value;
    const vPass2 = pass2.value;

    let ok = true;
    if(!validateEmail(vEmail)){ email.classList.add('error'); showAlert('请输入有效的邮箱地址', 'error'); ok=false; }
    else email.classList.remove('error');

    if(!/^\d{6}$/.test(vCode)){ code.classList.add('error'); showAlert('请输入 6 位数字验证码', 'error'); ok=false; }
    else code.classList.remove('error');

    if(vPass.length < 8 || vPass.length > 20){ pass.classList.add('error'); showAlert('新密码长度需为 8-20 位', 'error'); ok=false; }
    else pass.classList.remove('error');

    if(vPass !== vPass2){ pass2.classList.add('error'); showAlert('两次输入的新密码不一致', 'error'); ok=false; }
    else pass2.classList.remove('error');

    if(!ok) return;

    showLoading();
    const fd = new FormData();
    fd.append('email', vEmail);
    fd.append('code', vCode);
    fd.append('password', vPass);

    fetch('/user/forgot-password/reset', { method:'POST', body: fd })
      .then(r => { if(!r.ok) throw new Error('网络错误'); return r.json(); })
      .then(d => {
        hideLoading();
        if(d.success){
          showAlert('密码已重置，正在跳转到登录页...', 'success');
          setTimeout(()=>{ window.location.href = '/user/login'; }, 1500);
        }else{
          showAlert(d.message || '重置失败', 'error');
        }
      })
      .catch(e => { hideLoading(); showAlert('重置失败，请稍后重试', 'error'); console.error(e); });
  });

  [email, code, pass, pass2].forEach(i => i.addEventListener('input', ()=> i.classList.remove('error')));
})();
</script>
{% endblock %}
