{% extends "layout.html" %}

{% block title %}å•†æˆ·æ³¨å†Œ - æ—…æ¸¸å°åŠ©æ‰‹{% endblock %}

{% block css %}
<style>
    /* å•†æˆ·æ³¨å†Œé¡µé¢æ ·å¼ */
    .merchant-register-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 40px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-top: 30px;
        margin-bottom: 30px;
    }
    .merchant-register-header { text-align: center; margin-bottom: 30px; }
    .merchant-register-title { font-size: 28px; font-weight: 600; color: #2c3e50; margin-bottom: 10px; }
    .merchant-register-subtitle { color: #7f8c8d; }
    .merchant-logo {
        width: 80px; height: 80px; margin: 0 auto 20px; background-color: #3498db;
        border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 40px;
    }
    .form-row { display: flex; gap: 20px; margin-bottom: 20px; }
    .form-group { flex: 1; margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #34495e; }
    .form-control {
        width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 16px; transition: border-color 0.3s ease;
    }
    .form-control:focus { outline: none; border-color: #3498db; }
    .password-strength { margin-top: 5px; height: 5px; border-radius: 3px; background-color: #eee; position: relative; overflow: hidden; }
    .password-strength-bar { height: 100%; width: 0; transition: width 0.3s ease, background-color 0.3s ease; }
    .strength-weak .password-strength-bar { width: 33%; background-color: #e74c3c; }
    .strength-medium .password-strength-bar { width: 66%; background-color: #f39c12; }
    .strength-strong .password-strength-bar { width: 100%; background-color: #27ae60; }
    .password-strength-text { font-size: 14px; margin-top: 5px; color: #7f8c8d; }
    .btn-primary {
        width: 100%; padding: 12px; font-size: 16px; font-weight: 600; border: none; border-radius: 4px;
        background-color: #3498db; color: white; cursor: pointer; transition: background-color 0.3s ease;
    }
    .btn-primary:hover { background-color: #2980b9; }
    .btn-primary:disabled { background-color: #bdc3c7; cursor: not-allowed; }
    .register-links { margin-top: 20px; text-align: center; }
    .register-links a { color: #3498db; text-decoration: none; transition: color 0.3s ease; }
    .register-links a:hover { color: #2980b9; text-decoration: underline; }
    .business-types { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; }
    .business-type {
        flex: 1; min-width: 120px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px;
        cursor: pointer; transition: all 0.3s ease; text-align: center;
    }
    .business-type:hover { border-color: #3498db; background-color: #f8f9fa; }
    .business-type.selected { border-color: #3498db; background-color: #e3f2fd; }
    .business-type-icon { font-size: 32px; margin-bottom: 10px; }
    .business-type-name { font-weight: 500; color: #34495e; }
    .terms-agreement { margin-top: 20px; margin-bottom: 20px; }
    .terms-agreement label { display: flex; align-items: flex-start; font-size: 14px; color: #7f8c8d; }
    .terms-agreement input[type="checkbox"] { margin-right: 10px; margin-top: 2px; }
    .terms-agreement a { color: #3498db; text-decoration: none; }
    .terms-agreement a:hover { text-decoration: underline; }
    @media (max-width: 768px) {
        .merchant-register-container { padding: 30px 20px; margin-top: 20px; margin-bottom: 20px; }
        .form-row { flex-direction: column; gap: 0; }
        .business-types { flex-direction: column; }
        .business-type { min-width: auto; }
    }
</style>
{% endblock %}

{% block content %}
<div class="merchant-register-container">
    <div class="merchant-register-header">
        <div class="merchant-logo">ğŸª</div>
        <h2 class="merchant-register-title">å•†æˆ·æ³¨å†Œ</h2>
        <p class="merchant-register-subtitle">åŠ å…¥æ—…æ¸¸å°åŠ©æ‰‹ï¼Œè®©æ›´å¤šæ¸¸å®¢å‘ç°æ‚¨çš„æœåŠ¡</p>
    </div>

    <form id="merchant-register-form">
        <!-- å•†å®¶ç±»å‹é€‰æ‹© -->
        <div class="form-group">
            <label>å•†å®¶ç±»å‹</label>
            <div class="business-types">
                <div class="business-type" data-type="hotel">
                    <div class="business-type-icon">ğŸ¨</div>
                    <div class="business-type-name">é…’åº—ä½å®¿</div>
                </div>
                <div class="business-type" data-type="attraction">
                    <div class="business-type-icon">ğŸ¯</div>
                    <div class="business-type-name">æ—…æ¸¸æ™¯åŒº</div>
                </div>
                <div class="business-type" data-type="restaurant">
                    <div class="business-type-icon">ğŸ½ï¸</div>
                    <div class="business-type-name">é¤é¥®ç¾é£Ÿ</div>
                </div>
                <div class="business-type" data-type="other">
                    <div class="business-type-icon">ğŸ”„</div>
                    <div class="business-type-name">å…¶ä»–æœåŠ¡</div>
                </div>
            </div>
            <input type="hidden" id="business-type-input" name="business_type" required>
        </div>

        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <div class="form-row">
            <div class="form-group">
                <label for="merchant-username">ç”¨æˆ·å</label>
                <input type="text" id="merchant-username" name="username" class="form-control" placeholder="è¯·è®¾ç½®ç™»å½•ç”¨æˆ·å" required>
            </div>
            <div class="form-group">
                <label for="merchant-phone">è”ç³»ç”µè¯</label>
                <input type="tel" id="merchant-phone" name="phone" class="form-control" placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯" required>
            </div>
        </div>

        <div class="form-group">
            <label for="merchant-email">ç”µå­é‚®ç®±</label>
            <input type="email" id="merchant-email" name="email" class="form-control" placeholder="è¯·è¾“å…¥ç”µå­é‚®ç®±" required>
        </div>

        <!-- å¯†ç è®¾ç½® -->
        <div class="form-group">
            <label for="merchant-password">å¯†ç </label>
            <input type="password" id="merchant-password" name="password" class="form-control" placeholder="è¯·è®¾ç½®å¯†ç " required>
            <div class="password-strength"><div class="password-strength-bar"></div></div>
            <div class="password-strength-text">å¯†ç å¼ºåº¦ï¼šè¯·è¾“å…¥å¯†ç </div>
        </div>

        <div class="form-group">
            <label for="merchant-confirm-password">ç¡®è®¤å¯†ç </label>
            <input type="password" id="merchant-confirm-password" class="form-control" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " required>
            <div id="password-match-message" class="form-text" style="display: none;"></div>
        </div>

        <!-- éªŒè¯ç  -->
        <div class="form-group">
            <label for="captcha">éªŒè¯ç </label>
            <div class="captcha-container">
                <input type="text" id="captcha" name="captcha" class="form-control captcha-input"
                       placeholder="è¯·è¾“å…¥éªŒè¯ç " required>
                <div class="captcha-image" id="captcha-image" onclick="refreshCaptcha()">
                    <span id="captcha-text">ABCD</span>
                </div>
            </div>
            <div class="error-message" id="captcha-error">è¯·è¾“å…¥æ­£ç¡®çš„éªŒè¯ç </div>
            <div class="form-hint">ç‚¹å‡»éªŒè¯ç å›¾ç‰‡å¯åˆ·æ–°</div>
        </div>

        <!-- ç”¨æˆ·åè®® -->
        <div class="terms-agreement">
            <label>
                <input type="checkbox" id="agree-terms" name="agree_terms" required>
                æˆ‘å·²é˜…è¯»å¹¶åŒæ„<a href="#" target="_blank">ã€Šå•†æˆ·æœåŠ¡åè®®ã€‹</a>å’Œ<a href="#" target="_blank">ã€Šéšç§æ”¿ç­–ã€‹</a>ï¼Œäº†è§£å¹¶æ¥å—æ‰€æœ‰æ¡æ¬¾å†…å®¹ã€‚
            </label>
        </div>

        <!-- æäº¤æŒ‰é’® -->
        <div class="form-group">
            <button type="submit" class="btn btn-primary" id="register-button">
                <span id="register-text">æ³¨å†Œ</span>
                <span id="register-loading" style="display: none;">æ³¨å†Œä¸­...</span>
            </button>
        </div>
    </form>

    <div class="register-links">
        <span>å·²æœ‰è´¦å·ï¼Ÿ</span>
        <a href="{{ url_for('merchant.merchant_login') }}">ç«‹å³ç™»å½•</a>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // -------- é€šç”¨æç¤º --------
    function showAlert(message, type = 'info') {
        document.querySelectorAll('.alert').forEach(el => el.remove());
        const div = document.createElement('div');
        div.className = `alert alert-${type}`;
        div.style.cssText = `
            padding:12px 15px;margin:12px 0;border-radius:4px;color:#fff;font-weight:500;
            background:${type==='success'?'#27ae60':type==='error'?'#e74c3c':'#3498db'};
        `;
        div.textContent = message;
        document.querySelector('.merchant-register-container').insertBefore(div, document.querySelector('.merchant-register-container').firstChild);
        setTimeout(()=>div.remove(), 3000);
    }

    const registerForm = document.getElementById('merchant-register-form');
    const registerButton = document.getElementById('register-button');
    const registerText = document.getElementById('register-text');
    const registerLoading = document.getElementById('register-loading');
    const passwordInput = document.getElementById('merchant-password');
    const confirmPasswordInput = document.getElementById('merchant-confirm-password');
    const passwordStrength = document.querySelector('.password-strength');
    const passwordStrengthText = document.querySelector('.password-strength-text');
    const passwordMatchMessage = document.getElementById('password-match-message');
    const businessTypes = document.querySelectorAll('.business-type');
    const businessTypeInput = document.getElementById('business-type-input');
    const sendCodeBtn = document.getElementById('send-code-btn');

    // -------- å•†å®¶ç±»å‹é€‰æ‹© --------
    businessTypes.forEach(type => {
        type.addEventListener('click', function() {
            businessTypes.forEach(t => t.classList.remove('selected'));
            this.classList.add('selected');
            businessTypeInput.value = this.getAttribute('data-type');
        });
    });

    // -------- å¯†ç å¼ºåº¦ --------
    passwordInput.addEventListener('input', function() {
        const password = this.value;
        let s = 0;
        if (password.length >= 8) s++;
        if (/[A-Z]/.test(password)) s++;
        if (/[0-9]/.test(password)) s++;
        if (/[^A-Za-z0-9]/.test(password)) s++;

        passwordStrength.classList.remove('strength-weak', 'strength-medium', 'strength-strong');
        if (!password) {
            passwordStrengthText.textContent = 'å¯†ç å¼ºåº¦ï¼šè¯·è¾“å…¥å¯†ç ';
        } else if (s <= 2) {
            passwordStrength.classList.add('strength-weak');
            passwordStrengthText.textContent = 'å¯†ç å¼ºåº¦ï¼šå¼±';
        } else if (s === 3) {
            passwordStrength.classList.add('strength-medium');
            passwordStrengthText.textContent = 'å¯†ç å¼ºåº¦ï¼šä¸­';
        } else {
            passwordStrength.classList.add('strength-strong');
            passwordStrengthText.textContent = 'å¯†ç å¼ºåº¦ï¼šå¼º';
        }
        checkPasswordMatch();
    });

    // -------- ç¡®è®¤å¯†ç åŒ¹é… --------
    confirmPasswordInput.addEventListener('input', checkPasswordMatch);
    function checkPasswordMatch() {
        const p = passwordInput.value;
        const c = confirmPasswordInput.value;
        if (c.length > 0) {
            passwordMatchMessage.style.display = 'block';
            if (p === c) {
                passwordMatchMessage.textContent = 'å¯†ç åŒ¹é…';
                passwordMatchMessage.style.color = '#27ae60';
            } else {
                passwordMatchMessage.textContent = 'å¯†ç ä¸åŒ¹é…';
                passwordMatchMessage.style.color = '#e74c3c';
            }
        } else {
            passwordMatchMessage.style.display = 'none';
        }
    }

    // åˆ·æ–°éªŒè¯ç 
    window.refreshCaptcha = function() {
        const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        let captcha = '';
        for (let i = 0; i < 4; i++) {
            captcha += chars[Math.floor(Math.random() * chars.length)];
        }
        document.getElementById('captcha-text').textContent = captcha;
        document.getElementById('captcha-image').style.transform = `rotate(${Math.random() * 6 - 3}deg)`;
    };
    refreshCaptcha(); // åˆå§‹åŠ è½½

    // åœ¨è¡¨å•æäº¤æ—¶éªŒè¯éªŒè¯ç 
    function validateMerchantCaptcha() {
        const captchaInput = document.getElementById('merchant-captcha');
        const realCaptcha = document.getElementById('merchant-captcha-text').textContent;

        if (captchaInput.value.trim().toLowerCase() !== realCaptcha.toLowerCase()) {
            showError(captchaInput, 'merchant-captcha-error', 'éªŒè¯ç ä¸æ­£ç¡®');
            return false;
        } else {
            hideError(captchaInput, 'merchant-captcha-error');
            return true;
        }
    }

    // -------- æäº¤æ³¨å†Œï¼ˆçœŸå®è¯·æ±‚åç«¯ï¼‰ --------
    registerForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const username = document.getElementById('merchant-username').value.trim();
        const phone = document.getElementById('merchant-phone').value.trim();
        const email = document.getElementById('merchant-email').value.trim();
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        const verificationCode = document.getElementById('verification-code').value.trim();
        const agreeTerms = document.getElementById('agree-terms').checked;
        const businessType = businessTypeInput.value;

        if (!businessType) return showAlert('è¯·é€‰æ‹©å•†å®¶ç±»å‹', 'error');
        if (!username || username.length < 4) return showAlert('ç”¨æˆ·åè‡³å°‘éœ€è¦4ä¸ªå­—ç¬¦', 'error');
        if (!/^1[3-9]\d{9}$/.test(phone)) return showAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·ç ', 'error');
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return showAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€', 'error');
        if (password.length < 8) return showAlert('å¯†ç é•¿åº¦è‡³å°‘éœ€è¦8ä¸ªå­—ç¬¦', 'error');
        if (password !== confirmPassword) return showAlert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
        if (validateMerchantCaptcha()) return showAlert('éªŒè¯ç ä¸æ­£ç¡®', 'error');
        if (!agreeTerms) return showAlert('è¯·é˜…è¯»å¹¶åŒæ„ç”¨æˆ·åè®®å’Œéšç§æ”¿ç­–', 'error');

        registerText.style.display = 'none';
        registerLoading.style.display = 'inline';
        registerButton.disabled = true;

        const fd = new FormData();
        fd.append('business_type', businessType);
        fd.append('username', username);
        fd.append('phone', phone);
        fd.append('email', email);
        fd.append('password', password);
        fd.append('code', verificationCode);

        fetch('{{ url_for("merchant.merchant_register") }}', {
            method: 'POST',
            body: fd
        })
        .then(r => { if (!r.ok) throw new Error('ç½‘ç»œé”™è¯¯'); return r.json(); })
        .then(d => {
            registerText.style.display = 'inline';
            registerLoading.style.display = 'none';
            registerButton.disabled = false;

            if (d.success) {
                showAlert('æ³¨å†ŒæˆåŠŸï¼å¾…å®¡æ ¸é€šè¿‡åå³å¯ç™»å½•', 'success');
                setTimeout(() => {
                    window.location.href = '{{ url_for("merchant.merchant_login") }}';
                }, 1200);
            } else {
                showAlert(d.message || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        })
        .catch(err => {
            console.error('æ³¨å†Œå¤±è´¥ï¼š', err);
            registerText.style.display = 'inline';
            registerLoading.style.display = 'none';
            registerButton.disabled = false;
            showAlert('æ³¨å†Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•', 'error');
        });
    });

    // -------- å¯†ç æ˜¾ç¤º/éšè—åˆ‡æ¢ --------
    function addPasswordToggle(inputId) {
        const input = document.getElementById(inputId);
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'toggle-password';
        btn.style.position = 'absolute';
        btn.style.right = '15px';
        btn.style.top = '50%';
        btn.style.transform = 'translateY(-50%)';
        btn.style.background = 'none';
        btn.style.border = 'none';
        btn.style.cursor = 'pointer';
        btn.innerHTML = '<i class="fas fa-eye"></i>';

        const group = input.closest('.form-group');
        group.style.position = 'relative';
        group.appendChild(btn);

        btn.addEventListener('click', function() {
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);
            this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });
    }
    addPasswordToggle('merchant-password');
    addPasswordToggle('merchant-confirm-password');
});
</script>
{% endblock %}
