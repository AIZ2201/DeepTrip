{% extends "layout.html" %}
{% block title %}店铺信息上传 - 旅游小助手{% endblock %}

{% block css %}
<style>
    .shop-info-container { max-width: 900px; margin: 0 auto; padding: 40px; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 30px; margin-bottom: 30px; }
    .shop-info-header { text-align: center; margin-bottom: 40px; }
    .shop-info-title { font-size: 28px; font-weight: 600; color: #2c3e50; margin-bottom: 10px; }
    .shop-info-subtitle { color: #7f8c8d; }
    .form-section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #e0e0e0; }
    .form-section:last-child { border-bottom: none; padding-bottom: 0; }
    .form-section-title { font-size: 20px; font-weight: 600; color: #34495e; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #3498db; }
    .form-row { display: flex; gap: 20px; margin-bottom: 20px; }
    .form-group { flex: 1; margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #34495e; }
    .form-control { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 16px; transition: border-color 0.3s ease; }
    .form-control:focus { outline: none; border-color: #3498db; }
    textarea.form-control { resize: vertical; min-height: 100px; }
    select.form-control { appearance: none; padding-right: 45px; }
    .image-upload-section { margin-bottom: 20px; }
    .image-upload-area { border: 2px dashed #bdc3c7; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; position: relative; min-height: 150px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .image-upload-icon { font-size: 48px; color: #bdc3c7; margin-bottom: 10px; }
    .image-upload-text { color: #7f8c8d; font-size: 16px; }
    .image-upload-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; }
    .image-preview-container { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px; }
    .image-preview { position: relative; width: 150px; height: 150px; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .image-preview img { width: 100%; height: 100%; object-fit: cover; }
    .image-preview-remove { position: absolute; top: 8px; right: 8px; background: rgba(231,76,60,0.8); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    .image-preview-remove:hover { background: #e74c3c; }
    .business-hours-container { margin-top: 15px; }
    .business-hour-item { display: flex; align-items: center; margin-bottom: 10px; }
    .business-hour-day { width: 100px; font-weight: 500; }
    .business-hour-toggle { margin: 0 15px; }
    .business-hour-time { display: flex; align-items: center; gap: 10px; }
    .service-items-container { margin-top: 15px; }
    .service-item { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
    .service-item input[type="text"], .service-item input[type="number"] { flex: 1; padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 4px; }
    .remove-service-item { background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 8px 12px; cursor: pointer; }
    .remove-service-item:hover { background: #c0392b; }
    .add-service-item { background: #3498db; color: white; border: none; border-radius: 4px; padding: 10px 15px; cursor: pointer; margin-top: 10px; }
    .add-service-item:hover { background: #2980b9; }
    .btn-primary { padding: 12px 30px; font-size: 16px; font-weight: 600; border: none; border-radius: 4px; background: #3498db; color: white; cursor: pointer; }
    .btn-primary:hover { background: #2980b9; }
    .btn-primary:disabled { background: #bdc3c7; cursor: not-allowed; }
    .btn-secondary { padding: 12px 30px; font-size: 16px; font-weight: 600; border: 2px solid #3498db; border-radius: 4px; background: white; color: #3498db; cursor: pointer; }
    .btn-secondary:hover { background: #3498db; color: white; }
    .form-actions { display: flex; gap: 20px; justify-content: center; margin-top: 40px; }
    @media (max-width: 768px) {
        .shop-info-container { padding: 30px 20px; margin-top: 20px; margin-bottom: 20px; }
        .form-row { flex-direction: column; gap: 0; }
        .form-actions { flex-direction: column; }
        .form-actions button { width: 100%; }
        .business-hour-item { flex-direction: column; align-items: flex-start; gap: 10px; }
        .business-hour-day { width: auto; }
        .business-hour-time { flex-wrap: wrap; }
        .image-preview { width: 100px; height: 100px; }
    }
</style>
{% endblock %}

{% block content %}
<div class="shop-info-container">
    <div class="shop-info-header">
        <h2 class="shop-info-title">店铺信息上传</h2>
        <p class="shop-info-subtitle">完善您的店铺信息，吸引更多游客</p>
    </div>
    {% set type_map = {'hotel':'酒店住宿','attraction':'旅游景区','restaurant':'餐饮美食','other':'其他服务'} %}
    {% set price_map = {'budget':'经济型','standard':'标准型','mid_range':'中档型','luxury':'高档型'} %}
    {% if not editable and shop_info %}
    <div class="form-section">
        <h3 class="form-section-title">已上传店铺信息</h3>
        <ul>
            <li><strong>店铺名称：</strong>{{ shop_info.name }}</li>
            <li><strong>类别：</strong>{{ type_map.get(shop_info.category, shop_info.category) }}</li>
            <li><strong>价格区间：</strong>{{ price_map.get(shop_info.price_range, shop_info.price_range) }}</li>
            <li><strong>描述：</strong>{{ shop_info.description }}</li>
            <li><strong>地址：</strong>{{ shop_info.address }}</li>
            <li><strong>城市：</strong>{{ shop_info.city }}</li>
            <li><strong>区域：</strong>{{ shop_info.district }}</li>
            <li><strong>电话：</strong>{{ shop_info.phone }}</li>
            <li><strong>邮箱：</strong>{{ shop_info.email }}</li>
            <li><strong>网站：</strong>{{ shop_info.website }}</li>
            <li><strong>微信：</strong>{{ shop_info.wechat }}</li>
            <li><strong>节假日说明：</strong>{{ shop_info.holiday_info }}</li>
            <li><strong>营业时间：</strong>
                <ul>
                {% for bh in shop_info.business_hours %}
                    <li>{{ bh.day }}: {% if bh.isOpen %}{{ bh.startTime }}-{{ bh.endTime }}{% else %}休息{% endif %}</li>
                {% endfor %}
                </ul>
            </li>
            <li><strong>服务项目：</strong>
                <ul>
                {% for s in shop_info.service_items %}
                    <li>{{ s.name }} - {{ s.price }}元</li>
                {% endfor %}
                </ul>
            </li>
            <li><strong>店铺图片：</strong>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                {% for img in shop_info.images %}
                    <img src="{{ img }}" style="width:100px;height:100px;border-radius:8px;object-fit:cover;">
                {% endfor %}
                </div>
            </li>
        </ul>
        <div style="color:#e74c3c;margin-top:20px;">如需修改请联系管理员</div>
    </div>
    {% elif editable %}
    <form id="shop-info-form">
    <div class="form-section">
        <h3 class="form-section-title">基本信息</h3>
        <div class="form-group">
            <label for="shop-name">店铺名称 <span style="color: red;">*</span></label>
            <input type="text" id="shop-name" class="form-control" placeholder="请输入店铺名称" required value="{{ shop_info.name if shop_info else '' }}">
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="shop-category">商家类别 <span style="color: red;">*</span></label>
                <select id="shop-category" class="form-control" required>
                    <option value="">请选择商家类别</option>
                    <option value="hotel" {% if shop_info and shop_info.category == 'hotel' %}selected{% endif %}>酒店住宿</option>
                    <option value="restaurant" {% if shop_info and shop_info.category == 'restaurant' %}selected{% endif %}>餐饮美食</option>
                    <option value="attraction" {% if shop_info and shop_info.category == 'attraction' %}selected{% endif %}>旅游景区</option>
                    <option value="other" {% if shop_info and shop_info.category == 'other' %}selected{% endif %}>其他服务</option>
                </select>
            </div>
            <div class="form-group">
                <label for="shop-price-range">价格区间 <span style="color: red;">*</span></label>
                <select id="shop-price-range" class="form-control" required>
                    <option value="">请选择价格区间</option>
                    <option value="budget" {% if shop_info and shop_info.price_range == 'budget' %}selected{% endif %}>经济型 (¥0-¥100)</option>
                    <option value="standard" {% if shop_info and shop_info.price_range == 'standard' %}selected{% endif %}>标准型 (¥101-¥300)</option>
                    <option value="mid_range" {% if shop_info and shop_info.price_range == 'mid_range' %}selected{% endif %}>中档型 (¥301-¥800)</option>
                    <option value="luxury" {% if shop_info and shop_info.price_range == 'luxury' %}selected{% endif %}>高档型 (¥801以上)</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label for="shop-description">店铺描述 <span style="color: red;">*</span></label>
            <textarea id="shop-description" class="form-control" placeholder="详细描述您的店铺特色、服务内容等" required>{{ shop_info.description if shop_info else '' }}</textarea>
        </div>
    </div>
    <div class="form-section">
        <h3 class="form-section-title">位置信息</h3>
        <div class="form-group">
            <label for="shop-address">详细地址 <span style="color: red;">*</span></label>
            <input type="text" id="shop-address" class="form-control" placeholder="请输入详细地址" required value="{{ shop_info.address if shop_info else '' }}">
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="shop-city">所在城市 <span style="color: red;">*</span></label>
                <input type="text" id="shop-city" class="form-control" placeholder="请输入所在城市" required value="{{ shop_info.city if shop_info else '' }}">
            </div>
            <div class="form-group">
                <label for="shop-district">所在区域 <span style="color: red;">*</span></label>
                <input type="text" id="shop-district" class="form-control" placeholder="请输入所在区域" required value="{{ shop_info.district if shop_info else '' }}">
            </div>
        </div>
        <div class="form-group">
            <label for="shop-map">地图位置</label>
            <div id="map-placeholder" style="width: 100%; height: 300px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                <p style="color: #7f8c8d;">地图加载中...</p>
            </div>
        </div>
    </div>
    <div class="form-section">
        <h3 class="form-section-title">联系方式</h3>
        <div class="form-row">
            <div class="form-group">
                <label for="shop-phone">联系电话 <span style="color: red;">*</span></label>
                <input type="tel" id="shop-phone" class="form-control" placeholder="请输入联系电话" required value="{{ shop_info.phone if shop_info else '' }}">
            </div>
            <div class="form-group">
                <label for="shop-email">电子邮箱</label>
                <input type="email" id="shop-email" class="form-control" placeholder="请输入电子邮箱" value="{{ shop_info.email if shop_info else '' }}">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="shop-website">官方网站</label>
                <input type="url" id="shop-website" class="form-control" placeholder="请输入官方网站地址" value="{{ shop_info.website if shop_info else '' }}">
            </div>
            <div class="form-group">
                <label for="shop-wechat">微信公众号</label>
                <input type="text" id="shop-wechat" class="form-control" placeholder="请输入微信公众号名称" value="{{ shop_info.wechat if shop_info else '' }}">
            </div>
        </div>
    </div>
    <div class="form-section">
        <h3 class="form-section-title">营业时间</h3>
        <div class="business-hours-container">
            {% for day in ['周一', '周二', '周三', '周四', '周五', '周六', '周日'] %}
            <div class="business-hour-item">
                <div class="business-hour-day">{{ day }}</div>
                <div class="business-hour-toggle">
                    <label class="switch">
                        <input type="checkbox" class="day-toggle" data-day="{{ loop.index }}" checked>
                        <span class="slider round"></span>
                    </label>
                </div>
                <div class="business-hour-time">
                    <input type="time" class="business-hour-start" data-day="{{ loop.index }}" value="09:00">
                    <span>-</span>
                    <input type="time" class="business-hour-end" data-day="{{ loop.index }}" value="18:00">
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="form-group">
            <label for="shop-holiday-info">节假日营业时间说明</label>
            <textarea id="shop-holiday-info" class="form-control" placeholder="请说明节假日是否有特殊营业时间安排">{{ shop_info.holiday_info if shop_info else '' }}</textarea>
        </div>
    </div>
    <div class="form-section">
        <h3 class="form-section-title">服务项目</h3>
        <div id="service-items-container" class="service-items-container">
            <div class="service-item">
                <input type="text" placeholder="服务名称" class="service-name">
                <input type="number" placeholder="价格（元）" class="service-price" min="0" step="0.01">
                <button type="button" class="remove-service-item">删除</button>
            </div>
        </div>
        <button type="button" class="add-service-item" id="add-service-item-btn">添加服务项目</button>
    </div>
    <div class="form-section">
        <h3 class="form-section-title">店铺图片</h3>
        <div class="image-upload-section">
            <div class="image-upload-area" id="image-upload-area">
                <i class="fas fa-cloud-upload-alt image-upload-icon"></i>
                <div class="image-upload-text">
                    点击或拖拽图片到此处上传<br>
                    <strong>支持jpg、png、gif格式，单张不超过5MB</strong>
                </div>
                <input type="file" id="image-upload-input" class="image-upload-input" accept="image/*" multiple>
            </div>
            <div id="image-preview-container" class="image-preview-container"></div>
        </div>
    </div>
    <div class="form-actions">
        <button type="button" class="btn-secondary" id="save-draft-btn">保存草稿</button>
        <button type="submit" class="btn-primary" id="submit-btn">
            <span id="submit-text">提交审核</span>
            <span id="submit-loading" style="display: none;">提交中...</span>
        </button>
    </div>
    </form>
    {% endif %}
</div>
{% endblock %}

{% block js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 用 AJAX 获取 shop_info 数据
        fetch('/merchant/info/data')
            .then(res => res.json())
            .then(result => {
                if (result.success && result.data && {{ 'true' if editable else 'false' }}) {
                    window.fillFormWithShopInfo(result.data);
                }
            });

        // 表单校验函数（服务项目可为空）
        function validateForm() {
            let valid = true;
            // 基本信息
            const basicIds = ['shop-name', 'shop-category', 'shop-price-range', 'shop-description'];
            basicIds.forEach(id => {
                const el = document.getElementById(id);
                if (el && el.tagName === 'SELECT') {
                    if (!el.value || el.value === '') {
                        el.classList.add('error');
                        if (valid) el.scrollIntoView({behavior:'smooth'});
                        valid = false;
                    }
                } else if (el && !el.value.trim()) {
                    el.classList.add('error');
                    if (valid) el.scrollIntoView({behavior:'smooth'});
                    valid = false;
                }
            });
            // 位置信息
            const locationIds = ['shop-address', 'shop-city', 'shop-district'];
            locationIds.forEach(id => {
                const el = document.getElementById(id);
                if (el && !el.value.trim()) {
                    el.classList.add('error');
                    if (valid) el.scrollIntoView({behavior:'smooth'});
                    valid = false;
                }
            });
            // 联系方式
            const phoneEl = document.getElementById('shop-phone');
            if (phoneEl && !phoneEl.value.trim()) {
                phoneEl.classList.add('error');
                if (valid) phoneEl.scrollIntoView({behavior:'smooth'});
                valid = false;
            }
            // 服务项目可为空，不做强制校验
            return valid;
        }

        // 收集表单数据
        function collectFormData() {
            // 基本信息
            const basicInfo = {
                name: document.getElementById('shop-name').value,
                category: document.getElementById('shop-category').value,
                priceRange: document.getElementById('shop-price-range').value,
                description: document.getElementById('shop-description').value
            };
            // 位置信息
            const locationInfo = {
                address: document.getElementById('shop-address').value,
                city: document.getElementById('shop-city').value,
                district: document.getElementById('shop-district').value
            };
            // 联系方式
            const contactInfo = {
                phone: document.getElementById('shop-phone').value,
                email: document.getElementById('shop-email').value,
                website: document.getElementById('shop-website').value,
                wechat: document.getElementById('shop-wechat').value
            };
            // 营业时间
            const businessHours = [];
            document.querySelectorAll('.business-hour-item').forEach((item, index) => {
                const day = index + 1;
                const isOpen = item.querySelector(`.day-toggle[data-day="${day}"]`).checked;
                const startTime = item.querySelector(`.business-hour-start[data-day="${day}"]`).value;
                const endTime = item.querySelector(`.business-hour-end[data-day="${day}"]`).value;
                businessHours.push({
                    day: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'][index],
                    isOpen,
                    startTime,
                    endTime
                });
            });
            // 服务项目
            const serviceItems = [];
            document.querySelectorAll('.service-item').forEach(item => {
                const name = item.querySelector('.service-name').value;
                const price = item.querySelector('.service-price').value;
                if (name && price) {
                    serviceItems.push({ name, price });
                }
            });
            // 节假日信息
            const holidayInfo = document.getElementById('shop-holiday-info').value;
            // 图片
            const images = [];
            document.querySelectorAll('.image-preview img').forEach(img => {
                if (img.src) images.push(img.src);
            });
            return {
                basicInfo,
                locationInfo,
                contactInfo,
                businessHours,
                serviceItems,
                holidayInfo,
                images
            };
        }

        // 保存草稿
        document.getElementById('save-draft-btn').onclick = function() {
            if (!validateForm()) {
                alert('请填写所有必填项');
                return;
            }
            const formData = collectFormData();
            formData.action = 'save';
            fetch('/merchant/info', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            }).then(res => res.json()).then(result => {
                if (result.success) {
                    alert('保存成功');
                    setTimeout(function(){ window.location.href = '/merchant/home'; }, 1000);
                } else {
                    alert(result.message || '保存失败');
                }
            });
        };

        // 提交审核
        document.getElementById('shop-info-form').onsubmit = function(e) {
            e.preventDefault();
            if (!validateForm()) {
                alert('请填写所有必填项');
                return;
            }
            const formData = collectFormData();
            formData.action = 'submit';
            fetch('/merchant/info', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            }).then(res => res.json()).then(result => {
                if (result.success) {
                    alert('提交成功，等待审核');
                    setTimeout(function(){ window.location.href = '/merchant/home'; }, 1000);
                } else {
                    alert(result.message || '提交失败');
                }
            });
        };
    });
</script>
{% endblock %}