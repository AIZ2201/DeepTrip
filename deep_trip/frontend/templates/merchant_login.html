{% extends "layout.html" %}

{% block title %}商户登录 - 旅游小助手{% endblock %}

{% block css %}
<style>
  /* 样式同你原来，略 */
  .merchant-login-container{max-width:400px;margin:0 auto;padding:40px;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-top:50px;margin-bottom:50px}
  .merchant-login-header{text-align:center;margin-bottom:30px}
  .merchant-login-title{font-size:28px;font-weight:600;color:#2c3e50;margin-bottom:10px}
  .merchant-login-subtitle{color:#7f8c8d}
  .merchant-logo{width:80px;height:80px;margin:0 auto 20px;background:#3498db;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:40px}
  .form-group{margin-bottom:20px}
  .form-group label{display:block;margin-bottom:8px;font-weight:500;color:#34495e}
  .form-control{width:100%;padding:12px 15px;border:2px solid #e0e0e0;border-radius:4px;font-size:16px;transition:border-color .3s ease}
  .form-control:focus{outline:none;border-color:#3498db}
  .btn-primary{width:100%;padding:12px;font-size:16px;font-weight:600;border:none;border-radius:4px;background:#3498db;color:#fff;cursor:pointer;transition:background-color .3s ease}
  .btn-primary:hover{background:#2980b9}
  .btn-primary:disabled{background:#bdc3c7;cursor:not-allowed}
  .login-links{margin-top:20px;text-align:center}
  .login-links a{color:#3498db;text-decoration:none;transition:color .3s ease}
  .login-links a:hover{color:#2980b9;text-decoration:underline}
  .security-info{margin-top:20px;text-align:center;font-size:14px;color:#7f8c8d}
  @media (max-width:576px){
    .merchant-login-container{padding:30px 20px;margin-top:20px;margin-bottom:20px}
    .merchant-logo{width:60px;height:60px;font-size:30px}
    .merchant-login-title{font-size:24px}
  }
</style>
{% endblock %}

{% block content %}
<div class="merchant-login-container">
  <div class="merchant-login-header">
    <div class="merchant-logo">🏪</div>
    <h2 class="merchant-login-title">商户登录</h2>
    <p class="merchant-login-subtitle">欢迎回到旅游小助手商户平台</p>
  </div>

  <!-- 注意：加上 name 属性，和后端一致：email / password / remember -->
  <form id="merchant-login-form" method="post" action="{{ url_for('merchant.merchant_login') }}">
    <div class="form-group">
      <label for="merchant-email">电子邮箱</label>
      <input type="email" id="merchant-email" name="email" class="form-control" placeholder="请输入您的邮箱地址" required>
    </div>

    <div class="form-group" style="position:relative">
      <label for="merchant-password">
        密码
        <a href="/user/forgot-password" class="float-right" style="font-weight:normal;font-size:14px;">忘记密码？</a>
      </label>
      <input type="password" id="merchant-password" name="password" class="form-control" placeholder="请输入您的密码" required>
      <!-- 切换可见按钮 -->
      <button type="button" id="togglePwd" aria-label="显示/隐藏密码"
              style="position:absolute;right:12px;top:38px;background:none;border:none;cursor:pointer;">👁️</button>
    </div>

    <div class="form-group form-check">
      <label class="form-check-label">
        <input type="checkbox" class="form-check-input" id="remember" name="remember" value="1">
        记住我 30 天
      </label>
    </div>

    <div class="form-group">
      <button type="submit" class="btn btn-primary" id="login-button">
        <span id="login-text">登录</span>
        <span id="login-loading" style="display:none;">登录中...</span>
      </button>
    </div>
  </form>

  <div class="login-links">
    <span>还没有账号？</span>
    <a href="/merchant/register">立即注册</a>
  </div>

  <div class="security-info">
    <span>安全登录，保障您的信息安全</span>
  </div>
</div>
{% endblock %}

{% block js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('merchant-login-form');
  const btn = document.getElementById('login-button');
  const txt = document.getElementById('login-text');
  const loading = document.getElementById('login-loading');
  const emailInput = document.getElementById('merchant-email');
  const pwdInput = document.getElementById('merchant-password');
  const togglePwd = document.getElementById('togglePwd');

  // 密码可见性
  togglePwd.addEventListener('click', () => {
    const t = pwdInput.getAttribute('type') === 'password' ? 'text' : 'password';
    pwdInput.setAttribute('type', t);
  });

  // 简单校验
  function validEmail(v){
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
  }

  form.addEventListener('submit', function (e) {
    e.preventDefault();

    const email = emailInput.value.trim();
    const pwd = pwdInput.value.trim();
    if (!email || !pwd) { showAlert('请填写邮箱和密码', 'error'); return; }
    if (!validEmail(email)) { showAlert('请输入有效的邮箱地址', 'error'); return; }

    // UI: loading
    btn.disabled = true; txt.style.display='none'; loading.style.display='inline';

    // 真正向后端提交
    const fd = new FormData(form);
    fetch('/merchant/login', { method: 'POST', body: fd })
      .then(r => r.json())
      .then data => {
        btn.disabled = false; txt.style.display = 'inline'; loading.style.display = 'none';

        if (data.success) {
          // 后端 app.py 已返回 redirect:url_for('merchant_home')
          const target = data.redirect || '/merchant/home';
          showAlert('登录成功，正在跳转...', 'success');
          setTimeout(() => { window.location.href = target; }, 800);
        } else {
          showAlert(data.message || '登录失败', 'error');
        }
      })
      .catch(err => {
        btn.disabled = false; txt.style.display = 'inline'; loading.style.display = 'none';
        console.error(err);
        showAlert('网络错误，请稍后再试', 'error');
      });
  });

  // 失焦校验邮箱
  emailInput.addEventListener('blur', function () {
    if (this.value && !validEmail(this.value)) {
      showAlert('请输入有效的邮箱地址', 'error');
    }
  });
});

/* 轻量提示：若你项目里已全局提供 showAlert，可删除这个兜底实现 */
function showAlert(msg, type){
  // type: success / error / info
  const colors = {success:'#27ae60', error:'#e74c3c', info:'#3498db'};
  const box = document.createElement('div');
  box.textContent = msg;
  box.style.cssText = `
    position:fixed;top:20px;left:50%;transform:translateX(-50%);
    background:${colors[type]||'#333'};color:#fff;padding:10px 14px;border-radius:6px;
    z-index:9999;box-shadow:0 2px 8px rgba(0,0,0,.15);font-size:14px`;
  document.body.appendChild(box);
  setTimeout(()=>{ box.style.opacity='0'; box.style.transition='opacity .3s'; }, 1800);
  setTimeout(()=>{ box.remove(); }, 2200);
}
</script>
{% endblock %}
