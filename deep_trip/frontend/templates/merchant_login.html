{% extends "layout.html" %}

{% block title %}å•†æˆ·ç™»å½• - æ—…æ¸¸å°åŠ©æ‰‹{% endblock %}

{% block css %}
<style>
  /* æ ·å¼åŒä½ åŸæ¥ï¼Œç•¥ */
  .merchant-login-container{max-width:400px;margin:0 auto;padding:40px;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-top:50px;margin-bottom:50px}
  .merchant-login-header{text-align:center;margin-bottom:30px}
  .merchant-login-title{font-size:28px;font-weight:600;color:#2c3e50;margin-bottom:10px}
  .merchant-login-subtitle{color:#7f8c8d}
  .merchant-logo{width:80px;height:80px;margin:0 auto 20px;background:#3498db;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:40px}
  .form-group{margin-bottom:20px}
  .form-group label{display:block;margin-bottom:8px;font-weight:500;color:#34495e}
  .form-control{width:100%;padding:12px 15px;border:2px solid #e0e0e0;border-radius:4px;font-size:16px;transition:border-color .3s ease}
  .form-control:focus{outline:none;border-color:#3498db}
  .btn-primary{width:100%;padding:12px;font-size:16px;font-weight:600;border:none;border-radius:4px;background:#3498db;color:#fff;cursor:pointer;transition:background-color .3s ease}
  .btn-primary:hover{background:#2980b9}
  .btn-primary:disabled{background:#bdc3c7;cursor:not-allowed}
  .login-links{margin-top:20px;text-align:center}
  .login-links a{color:#3498db;text-decoration:none;transition:color .3s ease}
  .login-links a:hover{color:#2980b9;text-decoration:underline}
  .security-info{margin-top:20px;text-align:center;font-size:14px;color:#7f8c8d}
  @media (max-width:576px){
    .merchant-login-container{padding:30px 20px;margin-top:20px;margin-bottom:20px}
    .merchant-logo{width:60px;height:60px;font-size:30px}
    .merchant-login-title{font-size:24px}
  }
</style>
{% endblock %}

{% block content %}
<div class="merchant-login-container">
  <div class="merchant-login-header">
    <div class="merchant-logo">ğŸª</div>
    <h2 class="merchant-login-title">å•†æˆ·ç™»å½•</h2>
    <p class="merchant-login-subtitle">æ¬¢è¿å›åˆ°æ—…æ¸¸å°åŠ©æ‰‹å•†æˆ·å¹³å°</p>
  </div>

  <!-- æ³¨æ„ï¼šåŠ ä¸Š name å±æ€§ï¼Œå’Œåç«¯ä¸€è‡´ï¼šemail / password / remember -->
  <form id="merchant-login-form" method="post" action="{{ url_for('merchant.merchant_login') }}">
    <div class="form-group">
      <label for="merchant-email">ç”µå­é‚®ç®±</label>
      <input type="email" id="merchant-email" name="email" class="form-control" placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€" required>
    </div>

    <div class="form-group" style="position:relative">
      <label for="merchant-password">
        å¯†ç 
        <a href="/user/forgot-password" class="float-right" style="font-weight:normal;font-size:14px;">å¿˜è®°å¯†ç ï¼Ÿ</a>
      </label>
      <input type="password" id="merchant-password" name="password" class="form-control" placeholder="è¯·è¾“å…¥æ‚¨çš„å¯†ç " required>
      <!-- åˆ‡æ¢å¯è§æŒ‰é’® -->
      <button type="button" id="togglePwd" aria-label="æ˜¾ç¤º/éšè—å¯†ç "
              style="position:absolute;right:12px;top:38px;background:none;border:none;cursor:pointer;">ğŸ‘ï¸</button>
    </div>

    <div class="form-group form-check">
      <label class="form-check-label">
        <input type="checkbox" class="form-check-input" id="remember" name="remember" value="1">
        è®°ä½æˆ‘ 30 å¤©
      </label>
    </div>

    <div class="form-group">
      <button type="submit" class="btn btn-primary" id="login-button">
        <span id="login-text">ç™»å½•</span>
        <span id="login-loading" style="display:none;">ç™»å½•ä¸­...</span>
      </button>
    </div>
  </form>

  <div class="login-links">
    <span>è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</span>
    <a href="/merchant/register">ç«‹å³æ³¨å†Œ</a>
  </div>

  <div class="security-info">
    <span>å®‰å…¨ç™»å½•ï¼Œä¿éšœæ‚¨çš„ä¿¡æ¯å®‰å…¨</span>
  </div>
</div>
{% endblock %}

{% block js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('merchant-login-form');
  const btn = document.getElementById('login-button');
  const txt = document.getElementById('login-text');
  const loading = document.getElementById('login-loading');
  const emailInput = document.getElementById('merchant-email');
  const pwdInput = document.getElementById('merchant-password');
  const togglePwd = document.getElementById('togglePwd');

  // å¯†ç å¯è§æ€§
  togglePwd.addEventListener('click', () => {
    const t = pwdInput.getAttribute('type') === 'password' ? 'text' : 'password';
    pwdInput.setAttribute('type', t);
  });

  // ç®€å•æ ¡éªŒ
  function validEmail(v){
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
  }

  form.addEventListener('submit', function (e) {
    e.preventDefault();

    const email = emailInput.value.trim();
    const pwd = pwdInput.value.trim();
    if (!email || !pwd) { showAlert('è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ', 'error'); return; }
    if (!validEmail(email)) { showAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€', 'error'); return; }

    // UI: loading
    btn.disabled = true; txt.style.display='none'; loading.style.display='inline';

    // çœŸæ­£å‘åç«¯æäº¤
    const fd = new FormData(form);
    fetch('/merchant/login', { method: 'POST', body: fd })
      .then(r => r.json())
      .then data => {
        btn.disabled = false; txt.style.display = 'inline'; loading.style.display = 'none';

        if (data.success) {
          // åç«¯ app.py å·²è¿”å› redirect:url_for('merchant_home')
          const target = data.redirect || '/merchant/home';
          showAlert('ç™»å½•æˆåŠŸï¼Œæ­£åœ¨è·³è½¬...', 'success');
          setTimeout(() => { window.location.href = target; }, 800);
        } else {
          showAlert(data.message || 'ç™»å½•å¤±è´¥', 'error');
        }
      })
      .catch(err => {
        btn.disabled = false; txt.style.display = 'inline'; loading.style.display = 'none';
        console.error(err);
        showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•', 'error');
      });
  });

  // å¤±ç„¦æ ¡éªŒé‚®ç®±
  emailInput.addEventListener('blur', function () {
    if (this.value && !validEmail(this.value)) {
      showAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€', 'error');
    }
  });
});

/* è½»é‡æç¤ºï¼šè‹¥ä½ é¡¹ç›®é‡Œå·²å…¨å±€æä¾› showAlertï¼Œå¯åˆ é™¤è¿™ä¸ªå…œåº•å®ç° */
function showAlert(msg, type){
  // type: success / error / info
  const colors = {success:'#27ae60', error:'#e74c3c', info:'#3498db'};
  const box = document.createElement('div');
  box.textContent = msg;
  box.style.cssText = `
    position:fixed;top:20px;left:50%;transform:translateX(-50%);
    background:${colors[type]||'#333'};color:#fff;padding:10px 14px;border-radius:6px;
    z-index:9999;box-shadow:0 2px 8px rgba(0,0,0,.15);font-size:14px`;
  document.body.appendChild(box);
  setTimeout(()=>{ box.style.opacity='0'; box.style.transition='opacity .3s'; }, 1800);
  setTimeout(()=>{ box.remove(); }, 2200);
}
</script>
{% endblock %}
